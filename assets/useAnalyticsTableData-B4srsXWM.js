import{u as f,s as p}from"./index-QjVmUwmy.js";const S=(t,e,n=100)=>{if(e===0||e===null||e===void 0)return t>0?n:0;if(t==null)return 0;const s=(t-e)/Math.abs(e)*100;return Math.max(-n,Math.min(n,Math.round(s)))},m=(t,e=5)=>t==null||isNaN(t)?0:t>=1&&t<=e?t:t>=0&&t<=100?Math.max(1,Math.min(5,t/100*4+1)):Math.max(1,Math.min(e,t)),y=(t,e,n=5)=>e<n?t>e?10:0:S(t,e,100),v=t=>Array.isArray(t)?t.filter(e=>!e||typeof e!="object"?!1:(e.total_score!==null&&e.total_score!==void 0&&(e.total_score=m(e.total_score)),!0)):[],M=t=>{const e=v(t||[]),n=e.length,s=e.filter(o=>o.status==="completed").length,l=e.filter(o=>o.status==="in_progress").length,r=n-s-l,u=n>0?Math.round(s/n*100):0,i=e.filter(o=>o.status==="completed"&&o.total_score!==null).map(o=>m(o.total_score)),a=i.length>0?i.reduce((o,d)=>o+d,0)/i.length:0,h=i.filter(o=>o>=4).length,_=i.length>0?Math.round(h/i.length*100):0;return{totalSessions:n,completedSessions:s,inProgressSessions:l,abandonedSessions:r,completionRate:u,avgSessionScore:a,userSatisfactionRate:_,cleanedSessions:e}},q=t=>{const e=new Date;e.setDate(e.getDate()-30);const n=new Date;n.setDate(n.getDate()-60);const s=t.filter(r=>new Date(r.created_at)>=e).length,l=t.filter(r=>new Date(r.created_at)>=n&&new Date(r.created_at)<e).length;return y(s,l)},w=(t,e,n)=>(t||[]).map(s=>{const l=(e||[]).filter(d=>d.question_id===s.id),r=l.length,u=new Set(l.map(d=>d.session_id)),c=n>0?Math.round(u.size/n*100):0,i=l.filter(d=>d.score!==null),a=i.length>0?i.reduce((d,g)=>d+(g.score||0),0)/i.length:0,h=l.filter(d=>d.response_time_ms!==null),_=h.length>0?h.reduce((d,g)=>d+(g.response_time_ms||0),0)/h.length:0,o=[];return c>90&&o.push("High engagement - users complete this question consistently"),c<70&&o.push("Low completion - consider simplifying or repositioning"),a>4&&o.push("Positive sentiment - high satisfaction scores"),a<2.5&&o.push("Negative sentiment - requires attention"),_>3e4&&o.push("Long response time - may indicate complexity"),{id:s.id,question_text:s.question_text,question_type:s.question_type||"text",category:s.category||"General",total_responses:r,completion_rate:c,avg_score:Math.round(a*100)/100,avg_response_time_ms:Math.round(_),response_distribution:{},insights:o,trend:a>3.5?"positive":a<2.5?"negative":"neutral"}}),D=t=>{const e=new Map;return t.forEach(n=>{const s=n.category||"General";e.has(s)||e.set(s,[]),e.get(s).push(n)}),Array.from(e.entries()).map(([n,s])=>{const l=s.reduce((i,a)=>i+a.total_responses,0),r=s.length>0?s.reduce((i,a)=>i+a.completion_rate,0)/s.length:0,u=s.length>0?s.reduce((i,a)=>i+a.avg_score,0)/s.length:0,c=s.length>0?s.reduce((i,a)=>i+(a.avg_response_time_ms||0),0)/s.length:0;return{category:n,total_questions:s.length,total_responses:l,completion_rate:Math.round(r),questions:s,avg_score:Math.round(u*100)/100,avg_response_time_ms:Math.round(c)}})},R=t=>{const e=[];return Array.from({length:30},(s,l)=>{const r=new Date;return r.setDate(r.getDate()-l),r}).reverse().forEach(s=>{const l=s.toISOString().split("T")[0],r=t.filter(o=>o.created_at.startsWith(l)),u=r.length,c=r.filter(o=>o.status==="completed").length,i=u>0?Math.round(c/u*100):0,h=r.filter(o=>o.status==="completed"&&o.total_score!==null).map(o=>m(o.total_score)),_=h.length>0?h.reduce((o,d)=>o+d,0)/h.length:0;e.push({date:l,total_sessions:u,completed_sessions:c,completion_rate:i,avg_score:Math.round(_*100)/100})}),e},A=t=>f({queryKey:["analytics-table-data",t],queryFn:async()=>{console.log("Fetching analytics data for organization:",t);const{data:e,error:n}=await p.from("questions").select(`
          id,
          question_text,
          question_type,
          category,
          is_active,
          created_at
        `).eq("organization_id",t).eq("is_active",!0).order("created_at",{ascending:!1});if(n)throw console.error("Error fetching questions:",n),n;const{data:s,error:l}=await p.from("feedback_responses").select(`
          id,
          question_id,
          score,
          response_time_ms,
          created_at,
          question_category,
          session_id,
          response_value
        `).eq("organization_id",t);if(l)throw console.error("Error fetching responses:",l),l;const{data:r,error:u}=await p.from("feedback_sessions").select(`
          id,
          status,
          total_score,
          created_at,
          completed_at,
          started_at,
          user_id
        `).eq("organization_id",t).order("created_at",{ascending:!1});if(u)throw console.error("Error fetching sessions:",u),u;console.log("Raw data fetched:",{questions:(e==null?void 0:e.length)||0,responses:(s==null?void 0:s.length)||0,sessions:(r==null?void 0:r.length)||0});const c=M(r||[]),i=q(c.cleanedSessions),a=w(e||[],s||[],c.totalSessions),h=D(a),_=R(c.cleanedSessions),o={questions:a,categories:h,summary:{total_questions:a.length,total_responses:a.reduce((d,g)=>d+g.total_responses,0),overall_completion_rate:c.completionRate,total_sessions:c.totalSessions,completed_sessions:c.completedSessions,avg_score:Math.round(c.avgSessionScore*100)/100,user_satisfaction_rate:c.userSatisfactionRate,growth_rate:i,abandoned_sessions:c.abandonedSessions,response_rate:a.length>0&&c.totalSessions>0?Math.round(a.reduce((d,g)=>d+g.total_responses,0)/(a.length*c.totalSessions)*100):0},trendData:_};return console.log("Analytics result with safe calculations:",o),o},enabled:!!t,staleTime:5*60*1e3,refetchInterval:10*60*1e3});export{A as u};
