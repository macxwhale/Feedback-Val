import{u as k,s as _,j as e,B as N,U as F,C as u,a as h,b as w,c as q,d as B,e as U,f as T,E as z,g as C,h as L,R as G,r as y,i as H,k as K,T as Q}from"./index-Bvdx6vJq.js";const V=()=>k({mutationFn:async s=>{const{data:t,error:a}=await _.rpc("log_admin_action",{p_action:s.action,p_resource_type:s.resourceType,p_resource_id:s.resourceId||null,p_organization_id:s.organizationId||null,p_old_values:s.oldValues||null,p_new_values:s.newValues||null,p_severity:s.severity||"info",p_metadata:s.metadata||{}});if(a)throw a;return t}}),I=({organizationName:s,onInviteUser:t})=>e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Enhanced User Management"}),e.jsxs("p",{className:"text-gray-600",children:["Manage members for ",s]})]}),e.jsxs(N,{onClick:t,children:[e.jsx(F,{className:"w-4 h-4 mr-2"}),"Invite User"]})]}),J=({totalCount:s,users:t})=>{const a=t.filter(n=>n.status==="active").length;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(u,{children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"h-5 w-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:s}),e.jsx("p",{className:"text-sm text-gray-600",children:"Total Users"})]})]})})}),e.jsx(u,{children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:a}),e.jsx("p",{className:"text-sm text-gray-600",children:"Active Users"})]})]})})})]})},O=({currentPage:s,totalPages:t,hasMore:a,onPageChange:n,isLoading:r=!1})=>{const o=s>0,i=a;return e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>n(s-1),disabled:!o||r,children:[e.jsx(q,{className:"w-4 h-4 mr-1"}),"Previous"]}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>n(s+1),disabled:!i||r,children:["Next",e.jsx(B,{className:"w-4 h-4 ml-1"})]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Page ",s+1," ",t>0&&`of ${t}`]})]})},Y=({users:s,totalCount:t,isLoading:a,searchTerm:n,roleFilter:r,currentPage:o,totalPages:i,hasMore:x,onPageChange:j})=>e.jsxs(u,{children:[e.jsx(U,{children:e.jsxs(T,{children:["Users (",t,")"]})}),e.jsxs(h,{children:[a?e.jsx(z,{text:"Loading users..."}):s.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:n||r?"No users match your filters":"No users found"}):e.jsx("div",{className:"space-y-3",children:s.map(l=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsx("div",{className:"flex items-center space-x-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:l.email}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Joined ",new Date(l.created_at).toLocaleDateString()]})]})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(C,{variant:l.role==="admin"?"default":"secondary",children:l.role}),e.jsx(C,{variant:l.status==="active"?"default":"secondary",children:l.status})]})]},l.id))}),s.length>0&&e.jsx(O,{currentPage:o,totalPages:i,hasMore:x,onPageChange:j,isLoading:a})]})]}),$=s=>s.trim(),W=({organizationId:s,pageSize:t=20,pageOffset:a=0,searchTerm:n,roleFilter:r,enabled:o=!0})=>L({queryKey:["paginated-users",s,t,a,n,r],queryFn:async()=>{const{data:i,error:x}=await _.rpc("get_paginated_organization_users",{org_id:s,page_size:t,page_offset:a,search_term:n?$(n):null,role_filter:r==="all"?null:r||null});if(x)throw x;return i},enabled:!!s&&o,staleTime:3e4});async function X(s){const{data:t,error:a}=await _.rpc("is_current_user_org_admin",{org_id:s});return a?!1:!!t}const Z=G.memo(({organizationId:s,organizationName:t})=>{const[a,n]=y.useState(0),[r,o]=y.useState(""),[i,x]=y.useState("all"),{toast:j}=H();K();const l=V(),g=20,M=a*g,{data:m,isLoading:A}=L({queryKey:["is-org-admin",s],queryFn:()=>X(s),enabled:!!s,staleTime:10*60*1e3}),{data:c,isLoading:f,error:p}=W({organizationId:s,pageSize:g,pageOffset:M,searchTerm:r,roleFilter:i,enabled:!!s&&m===!0}),b=((c==null?void 0:c.users)??[]).filter(d=>!!d&&typeof d.id=="string"&&typeof d.email=="string"&&typeof d.role=="string"&&typeof d.status=="string"&&typeof d.created_at=="string"),v=(c==null?void 0:c.total_count)||0,E=(c==null?void 0:c.has_more)||!1,P=Math.ceil(v/g),R=d=>{n(d),l.mutate({action:"navigate_user_page",resourceType:"user_management",organizationId:s,metadata:{page:d,searchTerm:r,roleFilter:i}})},S=()=>{j({title:"Feature coming soon",description:"Invite user functionality will be implemented soon."})};return p||!f&&!m?e.jsxs(u,{children:[e.jsx(U,{children:e.jsxs(T,{className:"flex items-center text-red-600",children:[e.jsx(Q,{className:"w-5 h-5 mr-2"}),m===!1?"Access Denied":"Error Loading Users"]})}),e.jsxs(h,{children:[e.jsx("p",{className:"text-gray-600",children:m===!1?"You do not have permission to view this organization's users.":"Failed to load user data. Please try again."}),p&&e.jsxs("p",{className:"text-sm text-red-600 mt-2",children:["Error: ",p.message]})]})]}):A||f?e.jsx("div",{className:"py-10 text-center text-gray-400",children:"Loading..."}):e.jsxs("div",{className:"space-y-6 mt-8",children:[e.jsx(I,{organizationName:t,onInviteUser:S}),e.jsx(J,{totalCount:v,users:b}),e.jsx(Y,{users:b,totalCount:v,isLoading:f,searchTerm:r,roleFilter:i,currentPage:a,totalPages:P,hasMore:E,onPageChange:R})]})}),ee=({organization:s})=>e.jsx(Z,{organizationId:s.id,organizationName:s.name});export{ee as default};
