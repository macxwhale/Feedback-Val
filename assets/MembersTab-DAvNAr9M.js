import{u as S,s as v,j as e,C as h,a as u,U as _,B as b,b as P,c as q,d as C,e as U,E as B,f as w,g as L,R as F,r as y,h as k,T as z}from"./index-BVW_x7JI.js";const G=()=>S({mutationFn:async s=>{const{data:a,error:t}=await v.rpc("log_admin_action",{p_action:s.action,p_resource_type:s.resourceType,p_resource_id:s.resourceId||null,p_organization_id:s.organizationId||null,p_old_values:s.oldValues||null,p_new_values:s.newValues||null,p_severity:s.severity||"info",p_metadata:s.metadata||{}});if(t)throw t;return a}}),H=({organizationName:s})=>e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Enhanced User Management"}),e.jsxs("p",{className:"text-gray-600",children:["Manage members for ",s]})]})}),K=({totalCount:s,users:a})=>{const t=a.filter(n=>n.status==="active").length;return e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(h,{children:e.jsx(u,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(_,{className:"h-5 w-5 text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:s}),e.jsx("p",{className:"text-sm text-gray-600",children:"Total Users"})]})]})})}),e.jsx(h,{children:e.jsx(u,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(_,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:t}),e.jsx("p",{className:"text-sm text-gray-600",children:"Active Users"})]})]})})})]})},Q=({currentPage:s,totalPages:a,hasMore:t,onPageChange:n,isLoading:r=!1})=>{const o=s>0,l=t;return e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>n(s-1),disabled:!o||r,children:[e.jsx(P,{className:"w-4 h-4 mr-1"}),"Previous"]}),e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>n(s+1),disabled:!l||r,children:["Next",e.jsx(q,{className:"w-4 h-4 ml-1"})]})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Page ",s+1," ",a>0&&`of ${a}`]})]})},V=({users:s,totalCount:a,isLoading:t,searchTerm:n,roleFilter:r,currentPage:o,totalPages:l,hasMore:x,onPageChange:j})=>e.jsxs(h,{children:[e.jsx(C,{children:e.jsxs(U,{children:["Users (",a,")"]})}),e.jsxs(u,{children:[t?e.jsx(B,{text:"Loading users..."}):s.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:n||r?"No users match your filters":"No users found"}):e.jsx("div",{className:"space-y-3",children:s.map(i=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsx("div",{className:"flex items-center space-x-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i.email}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Joined ",new Date(i.created_at).toLocaleDateString()]})]})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{variant:i.role==="admin"?"default":"secondary",children:i.role}),e.jsx(w,{variant:i.status==="active"?"default":"secondary",children:i.status})]})]},i.id))}),s.length>0&&e.jsx(Q,{currentPage:o,totalPages:l,hasMore:x,onPageChange:j,isLoading:t})]})]}),J=s=>s.trim(),O=({organizationId:s,pageSize:a=20,pageOffset:t=0,searchTerm:n,roleFilter:r,enabled:o=!0})=>L({queryKey:["paginated-users",s,a,t,n,r],queryFn:async()=>{const{data:l,error:x}=await v.rpc("get_paginated_organization_users",{org_id:s,page_size:a,page_offset:t,search_term:n?J(n):null,role_filter:r==="all"?null:r||null});if(x)throw x;return l},enabled:!!s&&o,staleTime:3e4});async function Y(s){const{data:a,error:t}=await v.rpc("is_current_user_org_admin",{org_id:s});return t?!1:!!a}const $=F.memo(({organizationId:s,organizationName:a})=>{const[t,n]=y.useState(0),[r,o]=y.useState(""),[l,x]=y.useState("all");k();const j=G(),i=20,M=t*i,{data:m,isLoading:T}=L({queryKey:["is-org-admin",s],queryFn:()=>Y(s),enabled:!!s,staleTime:10*60*1e3}),{data:c,isLoading:g,error:f}=O({organizationId:s,pageSize:i,pageOffset:M,searchTerm:r,roleFilter:l,enabled:!!s&&m===!0}),N=((c==null?void 0:c.users)??[]).filter(d=>!!d&&typeof d.id=="string"&&typeof d.email=="string"&&typeof d.role=="string"&&typeof d.status=="string"&&typeof d.created_at=="string"),p=(c==null?void 0:c.total_count)||0,A=(c==null?void 0:c.has_more)||!1,E=Math.ceil(p/i),R=d=>{n(d),j.mutate({action:"navigate_user_page",resourceType:"user_management",organizationId:s,metadata:{page:d,searchTerm:r,roleFilter:l}})};return f||!g&&!m?e.jsxs(h,{children:[e.jsx(C,{children:e.jsxs(U,{className:"flex items-center text-red-600",children:[e.jsx(z,{className:"w-5 h-5 mr-2"}),m===!1?"Access Denied":"Error Loading Users"]})}),e.jsxs(u,{children:[e.jsx("p",{className:"text-gray-600",children:m===!1?"You do not have permission to view this organization's users.":"Failed to load user data. Please try again."}),f&&e.jsxs("p",{className:"text-sm text-red-600 mt-2",children:["Error: ",f.message]})]})]}):T||g?e.jsx("div",{className:"py-10 text-center text-gray-400",children:"Loading..."}):e.jsxs("div",{className:"space-y-6 mt-8",children:[e.jsx(H,{organizationName:a}),e.jsx(K,{totalCount:p,users:N}),e.jsx(V,{users:N,totalCount:p,isLoading:g,searchTerm:r,roleFilter:l,currentPage:t,totalPages:E,hasMore:A,onPageChange:R})]})}),X=({organization:s})=>e.jsx($,{organizationId:s.id,organizationName:s.name});export{X as default};
