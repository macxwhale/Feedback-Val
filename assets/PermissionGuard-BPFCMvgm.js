var A=Object.defineProperty;var E=(n,e,s)=>e in n?A(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var y=(n,e,s)=>E(n,typeof e!="symbol"?e+"":e,s);import{c as w,S as L,A as M,O as T,E as U,s as F,N as P,r as g,u as D,j as r,ag as S,C as v,k as C,p as R,T as _,l as j,i as b}from"./index-BAbdfhgo.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=w("Crown",[["path",{d:"M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z",key:"1vdc57"}],["path",{d:"M5 21h14",key:"11awu3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=w("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=w("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]),m={owner:{variant:"destructive",icon:B,label:"Owner",description:"Full access including billing and organization management",level:6,permissions:["*"]},admin:{variant:"default",icon:O,label:"Admin",description:"Full access except billing and ownership changes",level:5,permissions:["manage_users","manage_questions","view_analytics","export_data","manage_integrations"]},manager:{variant:"secondary",icon:L,label:"Manager",description:"Team management and question creation",level:4,permissions:["manage_questions","view_analytics","export_data","invite_users"]},analyst:{variant:"outline",icon:M,label:"Analyst",description:"Analytics access and data export",level:3,permissions:["view_analytics","export_data","manage_questions"]},member:{variant:"secondary",icon:T,label:"Member",description:"Basic access to view analytics",level:2,permissions:["view_analytics"]},viewer:{variant:"outline",icon:U,label:"Viewer",description:"Read-only access to basic analytics",level:1,permissions:["view_analytics"]}},N=n=>m[n]||m.member,k=(n,e)=>{var a,i;const s=((a=m[n])==null?void 0:a.level)||0,t=((i=m[e])==null?void 0:i.level)||0;return s>t},Y=n=>{var s;const e=((s=m[n])==null?void 0:s.level)||0;return Object.entries(m).filter(([,t])=>t.level<e).map(([t])=>t)},q=(n,e)=>{const s=m[n];return s?s.permissions.includes("*")?!0:s.permissions.includes(e):!1},G=n=>n.split("@")[0].slice(0,2).toUpperCase(),Q=n=>new Date(n).toLocaleDateString(),J=n=>n==="active"?"default":"secondary",W=n=>{const e=new Date(n),s=new Date;return(e.getTime()-s.getTime())/(1e3*60*60)<=24};class u{static async getUserRole(e,s){const t=`${e}-${s}`,a=this.roleCache.get(t);if(a&&Date.now()-a.timestamp<this.CACHE_TTL)return a.role;try{const{data:i,error:c}=await F.from("organization_users").select("enhanced_role").eq("user_id",e).eq("organization_id",s).single();if(c||!i)return null;const d=i.enhanced_role;return this.roleCache.set(t,{role:d,timestamp:Date.now()}),d}catch(i){return console.error("Error fetching user role:",i),null}}static async checkPermission(e,s,t){if(e.isAdmin)return{allowed:!0,reason:"System admin access"};let a=e.userRole;if(!a&&(a=await this.getUserRole(e.userId,e.organizationId),!a))return{allowed:!1,reason:"User role not found"};if(!q(a,s))return{allowed:!1,reason:`Role '${a}' lacks permission '${s}'`,requiredRole:this.getMinimumRoleForPermission(s)};if(s==="manage_users"&&t){const c=await this.getUserRole(t,e.organizationId);if(c&&!k(a,c))return{allowed:!1,reason:`Cannot manage user with role '${c}'`,requiredRole:c}}return{allowed:!0}}static async requirePermission(e,s,t){const a=await this.checkPermission(e,s,t);if(!a.allowed)throw new $(a.reason||"Access denied",a.requiredRole)}static getMinimumRoleForPermission(e){return{view_analytics:"viewer",export_data:"analyst",manage_questions:"analyst",manage_users:"manager",manage_integrations:"admin",manage_organization:"admin",manage_billing:"owner"}[e]||"admin"}static clearCache(e,s){e&&s?this.roleCache.delete(`${e}-${s}`):this.roleCache.clear()}}y(u,"roleCache",new Map),y(u,"CACHE_TTL",5*60*1e3);class $ extends Error{constructor(e,s){super(e),this.requiredRole=s,this.name="RBACError"}}const H=n=>{const{user:e,isAdmin:s,isOrgAdmin:t}=P(),a=g.useMemo(()=>!(e!=null&&e.id)||!n?null:{userId:e.id,organizationId:n,isAdmin:s},[e==null?void 0:e.id,n,s]),{data:i,isLoading:c,error:d}=D({queryKey:["user-role-rbac",e==null?void 0:e.id,n],queryFn:async()=>{if(!a)return null;try{const o=await u.getUserRole(a.userId,a.organizationId);return console.log("User role fetched:",o,"for user:",a.userId),o}catch(o){return console.error("Error fetching user role:",o),null}},enabled:!!a,staleTime:5*60*1e3,retry:3}),x=g.useCallback(async(o,l)=>a?u.checkPermission({...a,userRole:i||void 0},o,l):{allowed:!1,reason:"No valid context"},[a,i]),h=g.useCallback(async(o,l)=>{if(!a)throw new Error("No valid RBAC context");return u.requirePermission({...a,userRole:i||void 0},o,l)},[a,i]),p=g.useCallback(o=>{if(!a||!i)return console.log("Permission check failed: no context or role",{context:!!a,userRole:i}),!1;if(s||t)return console.log("Permission granted: admin access"),!0;const l=q(i,o);return console.log("Permission check:",{permission:o,userRole:i,allowed:l}),l},[a,i,s,t]),f=g.useCallback(async o=>{if(!a||!i)return!1;if(s||t)return!0;try{const l=await u.getUserRole(o,a.organizationId);return l?k(i,l):!1}catch(l){return console.error("Error checking user management permission:",l),!1}},[a,i,s,t]);return{userRole:i,isLoading:c,error:d,checkPermission:x,requirePermission:h,hasPermission:p,canManageUser:f,isAdmin:s||!1}},X=({children:n,permission:e,organizationId:s,fallback:t,showRequiredRole:a=!0})=>{const{hasPermission:i,userRole:c,isLoading:d,isAdmin:x,error:h}=H(s),{isOrgAdmin:p}=P();if(d)return r.jsx("div",{className:"flex items-center justify-center p-8",children:r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(S,{className:"h-4 w-4 animate-spin"}),r.jsx("span",{className:"text-sm text-gray-600",children:"Checking permissions..."})]})});if(h)return console.error("Permission guard error:",h),r.jsxs(v,{className:"border-amber-200",children:[r.jsx(C,{children:r.jsxs(R,{className:"flex items-center text-amber-600",children:[r.jsx(_,{className:"w-5 h-5 mr-2"}),"Permission Check Failed"]})}),r.jsx(j,{children:r.jsx("p",{className:"text-sm text-gray-600",children:"Unable to verify permissions. Please refresh the page or contact support if the issue persists."})})]});if(x||p)return console.log("Permission granted via admin privileges"),r.jsx(r.Fragment,{children:n});if(i(e))return console.log("Permission granted:",e),r.jsx(r.Fragment,{children:n});if(console.log("Permission denied:",{permission:e,userRole:c,organizationId:s}),t)return r.jsx(r.Fragment,{children:t});const f=I(e),o=N(f),l=c?N(c):null;return r.jsxs(v,{className:"border-red-200",children:[r.jsx(C,{children:r.jsxs(R,{className:"flex items-center text-red-600",children:[r.jsx(z,{className:"w-5 h-5 mr-2"}),"Access Restricted"]})}),r.jsxs(j,{className:"space-y-4",children:[r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(_,{className:"w-4 h-4 text-amber-500"}),r.jsx("span",{className:"text-sm text-gray-600",children:"You don't have permission to access this feature."})]}),a&&r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("span",{className:"text-sm font-medium",children:"Required role:"}),r.jsxs(b,{variant:o.variant,className:"flex items-center gap-1",children:[r.jsx(o.icon,{className:"w-3 h-3"}),o.label]})]}),l&&r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("span",{className:"text-sm font-medium",children:"Your role:"}),r.jsxs(b,{variant:l.variant,className:"flex items-center gap-1",children:[r.jsx(l.icon,{className:"w-3 h-3"}),l.label]})]})]}),r.jsx("p",{className:"text-xs text-gray-500",children:"Contact your organization administrator to request access."})]})]})};function I(n){return{view_analytics:"viewer",export_data:"analyst",manage_questions:"admin",manage_users:"admin",manage_integrations:"admin",manage_organization:"admin",manage_billing:"owner"}[n]||"admin"}export{X as P,O as S,Y as a,G as b,J as c,k as d,Q as f,N as g,q as h,W as i,H as u};
