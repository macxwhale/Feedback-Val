var Le=Object.defineProperty;var ze=(s,n,a)=>n in s?Le(s,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[n]=a;var P=(s,n,a)=>ze(s,typeof n!="symbol"?n+"":n,a);import{c as ne,j as e,i as B,J as Oe,r as p,P as K,K as Fe,L as se,a as $,N as Pe,u as D,s as j,C as w,l as R,O as Ve,D as qe,d as ke,B as T,e as Be,h as Ke,Q as O,V as C,W as m,U as $e,X as f,Y as b,_ as E,$ as I,a0 as V,a1 as q,a2 as ae,n as Qe,a3 as ie,a4 as G,I as Ye,a5 as We,T as Ge,v as He,w as Ze,x as H,y as Z}from"./index-CPt7zHrL.js";import{g as re,a as Je,b as Xe,h as en,c as nn,f as L,d as sn,S as an,i as rn,u as te,P as tn}from"./PermissionGuard-Dea75X51.js";import{T as oe,a as le,b as z,c as y,d as ce,e as _,A as de,f as ue,g as me,h as he,i as ve,j as ge,k as xe,l as fe,m as pe,D as on,n as ln,o as cn,p as dn,q as un}from"./dialog-Bex6WKjl.js";import{S as mn,a as hn,b as vn,c as gn,d as xn}from"./select-Dm3fg6UW.js";import{E as fn}from"./ellipsis-C3_uYHGi.js";import{T as pn}from"./trash-2-C_PuxQkw.js";import{u as F,t as J}from"./use-toast-6uyWm47E.js";import{C as jn}from"./clock-BgJPTegU.js";import"./index-fRZy5Npf.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const k=ne("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yn=ne("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),je=({role:s,showIcon:n=!1,className:a=""})=>{const i=re(s),r=i.icon;return e.jsxs(B,{variant:i.variant,className:a,children:[n&&e.jsx(r,{className:"w-3 h-3 mr-1"}),i.label]})},ye=({currentUserRole:s,selectedRole:n,onRoleChange:a,disabled:i=!1})=>{const r=Je(s),t=[...r];return n&&!r.includes(n)&&t.push(n),e.jsxs(mn,{value:n,onValueChange:a,disabled:i,children:[e.jsx(hn,{children:e.jsx(vn,{placeholder:"Select a role"})}),e.jsx(gn,{children:t.map(o=>{const l=re(o);return e.jsx(xn,{value:o,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l.icon,{className:"w-4 h-4"}),e.jsx("span",{children:l.label})]})},o)})})]})};var Q="Avatar",[_n,us]=Oe(Q),[In,_e]=_n(Q),Ie=p.forwardRef((s,n)=>{const{__scopeAvatar:a,...i}=s,[r,t]=p.useState("idle");return e.jsx(In,{scope:a,imageLoadingStatus:r,onImageLoadingStatusChange:t,children:e.jsx(K.span,{...i,ref:n})})});Ie.displayName=Q;var Ne="AvatarImage",Ee=p.forwardRef((s,n)=>{const{__scopeAvatar:a,src:i,onLoadingStatusChange:r=()=>{},...t}=s,o=_e(Ne,a),l=Nn(i,t.referrerPolicy),v=Fe(c=>{r(c),o.onImageLoadingStatusChange(c)});return se(()=>{l!=="idle"&&v(l)},[l,v]),l==="loaded"?e.jsx(K.img,{...t,ref:n,src:i}):null});Ee.displayName=Ne;var be="AvatarFallback",we=p.forwardRef((s,n)=>{const{__scopeAvatar:a,delayMs:i,...r}=s,t=_e(be,a),[o,l]=p.useState(i===void 0);return p.useEffect(()=>{if(i!==void 0){const v=window.setTimeout(()=>l(!0),i);return()=>window.clearTimeout(v)}},[i]),o&&t.imageLoadingStatus!=="loaded"?e.jsx(K.span,{...r,ref:n}):null});we.displayName=be;function Nn(s,n){const[a,i]=p.useState("idle");return se(()=>{if(!s){i("error");return}let r=!0;const t=new window.Image,o=l=>()=>{r&&i(l)};return i("loading"),t.onload=o("loaded"),t.onerror=o("error"),t.src=s,n&&(t.referrerPolicy=n),()=>{r=!1}},[s,n]),a}var Re=Ie,Ae=Ee,Se=we;const Me=p.forwardRef(({className:s,...n},a)=>e.jsx(Re,{ref:a,className:$("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...n}));Me.displayName=Re.displayName;const En=p.forwardRef(({className:s,...n},a)=>e.jsx(Ae,{ref:a,className:$("aspect-square h-full w-full",s),...n}));En.displayName=Ae.displayName;const Ce=p.forwardRef(({className:s,...n},a)=>e.jsx(Se,{ref:a,className:$("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...n}));Ce.displayName=Se.displayName;const bn=({email:s,size:n="md"})=>{const a={sm:"h-6 w-6",md:"h-8 w-8",lg:"h-10 w-10"};return e.jsx(Me,{className:a[n],children:e.jsx(Ce,{children:Xe(s)})})},Ue=s=>{const{user:n}=Pe(),{data:a}=D({queryKey:["user-enhanced-role",n==null?void 0:n.id,s],queryFn:async()=>{if(!(n!=null&&n.id)||!s)return null;const{data:h}=await j.from("organization_users").select("enhanced_role").eq("user_id",n.id).eq("organization_id",s).single();return(h==null?void 0:h.enhanced_role)||null},enabled:!!(n!=null&&n.id)&&!!s}),{data:i}=D({queryKey:["user-permissions",n==null?void 0:n.id,s,a],queryFn:async()=>{if(!(n!=null&&n.id)||!s||!a)return{};const{data:h}=await j.from("role_permissions").select("permission_key, permission_value").eq("role",a),g={};return h==null||h.forEach(({permission_key:M,permission_value:U})=>{try{const d=U;d&&typeof d=="object"&&"allowed"in d&&(g[M]=d)}catch(d){console.warn(`Failed to parse permission for ${M}:`,d)}}),g},enabled:!!(n!=null&&n.id)&&!!s&&!!a}),r=h=>{if(!a)return!1;const g=i==null?void 0:i[h];return g?g.allowed:en(a,h)};return{userRole:a,permissions:i,checkPermission:r,canManageUsers:()=>r("manage_users"),canManageOrganization:()=>r("manage_organization"),canViewAnalytics:()=>r("view_analytics"),canExportData:()=>r("export_data"),canManageQuestions:()=>r("manage_questions"),canManageIntegrations:()=>r("manage_integrations"),canManageBilling:()=>r("manage_billing")}},wn=({members:s,loading:n,organizationId:a,onUpdateRole:i,onRemoveMember:r})=>{const{userRole:t,canManageUsers:o}=Ue(a),l=(c,u)=>{i(c.user_id,u)},v=c=>{if(!o()||!t)return!1;const u=c.enhanced_role||c.role||"member";return sn(t,u)};return n?e.jsx(w,{children:e.jsx(R,{className:"p-6",children:e.jsx("div",{className:"text-center",children:"Loading members..."})})}):!s||s.length===0?e.jsx(w,{children:e.jsx(R,{className:"p-6",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(Ve,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("p",{children:"No members found"}),e.jsx("p",{className:"text-sm",children:"Invite users to get started"})]})})}):e.jsx(w,{children:e.jsx(R,{className:"p-0",children:e.jsxs(oe,{children:[e.jsx(le,{children:e.jsxs(z,{children:[e.jsx(y,{children:"Member"}),e.jsx(y,{children:"Role"}),e.jsx(y,{children:"Status"}),e.jsx(y,{children:"Joined"}),e.jsx(y,{children:"Invited By"}),e.jsx(y,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(ce,{children:s.map(c=>{var h;const u=c.enhanced_role||c.role||"member",N=v(c);return e.jsxs(z,{children:[e.jsx(_,{children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(bn,{email:c.email}),e.jsx("div",{children:e.jsx("div",{className:"font-medium",children:c.email})})]})}),e.jsx(_,{children:N?e.jsx(ye,{currentUserRole:t||"member",selectedRole:u,onRoleChange:g=>l(c,g)}):e.jsx(je,{role:u})}),e.jsx(_,{children:e.jsx(B,{variant:nn(c.status),children:c.status})}),e.jsx(_,{children:c.accepted_at?L(c.accepted_at):L(c.created_at)}),e.jsx(_,{children:((h=c.invited_by)==null?void 0:h.email)||"-"}),e.jsx(_,{children:N&&e.jsxs(qe,{children:[e.jsx(ke,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"sm",children:e.jsx(fn,{className:"h-4 w-4"})})}),e.jsx(Be,{align:"end",children:e.jsxs(de,{children:[e.jsx(ue,{asChild:!0,children:e.jsxs(Ke,{className:"text-red-600",onSelect:g=>g.preventDefault(),children:[e.jsx(pn,{className:"h-4 w-4 mr-2"}),"Remove Member"]})}),e.jsxs(me,{children:[e.jsxs(he,{children:[e.jsx(ve,{children:"Remove Member"}),e.jsxs(ge,{children:["Are you sure you want to remove ",c.email," from this organization? This action cannot be undone."]})]}),e.jsxs(xe,{children:[e.jsx(fe,{children:"Cancel"}),e.jsx(pe,{onClick:()=>r(c.user_id),className:"bg-red-600 hover:bg-red-700",children:"Remove"})]})]})]})})]})})]},c.id)})})]})})})},Rn=s=>D({queryKey:["organization-members",s],queryFn:async()=>{console.log("Fetching organization members for:",s);const{data:n,error:a}=await j.from("organization_users").select(`
          id,
          user_id,
          email,
          role,
          enhanced_role,
          status,
          created_at,
          accepted_at,
          invited_by_user_id
        `).eq("organization_id",s).order("created_at",{ascending:!1});if(a)throw console.error("Error fetching organization members:",a),a;const i=await Promise.all((n||[]).map(async r=>{let t=null;if(r.invited_by_user_id){const{data:o}=await j.from("organization_users").select("email").eq("user_id",r.invited_by_user_id).eq("organization_id",s).single();o?t={email:o.email}:t={email:"Unknown"}}return{...r,invited_by:t}}));return console.log("Organization members fetched:",i),i},enabled:!!s,retry:3,retryDelay:1e3}),An=s=>{const{data:n,...a}=Rn(s);return{activeMembers:(n==null?void 0:n.filter(r=>r.status==="active"))||[],...a}},Sn=s=>{const n=O();return F({mutationFn:async({userId:a,newRole:i})=>{console.log("Updating user role:",{userId:a,newRole:i,organizationId:s});const{data:r,error:t}=await j.from("organization_users").update({enhanced_role:i,role:i==="owner"||i==="admin"?"admin":"member"}).eq("user_id",a).eq("organization_id",s).select().single();if(t)throw console.error("Error updating user role:",t),t;return r},onSuccess:()=>{J({title:"User role updated successfully"}),n.invalidateQueries({queryKey:["organization-members",s]})},onError:a=>{console.error("Role update error:",a),J({title:"Error updating user role",description:a.message||"An unexpected error occurred",variant:"destructive"})}})},Mn=s=>{const{activeMembers:n,isLoading:a,error:i}=An(s),r=Sn(s);return{activeMembers:n,membersLoading:a,membersError:i,handleUpdateRole:(o,l)=>{r.mutate({userId:o,newRole:l})},updateRoleMutation:r}},Cn=s=>D({queryKey:["organization-invitations",s],queryFn:async()=>{console.log("Fetching organization invitations for:",s);const{data:n,error:a}=await j.from("user_invitations").select(`
          id,
          email,
          role,
          enhanced_role,
          status,
          created_at,
          expires_at,
          invited_by_user_id,
          organization_id
        `).eq("organization_id",s).order("created_at",{ascending:!1});if(a)throw console.error("Error fetching organization invitations:",a),a;return await Promise.all((n||[]).map(async r=>{if(r.invited_by_user_id)try{const{data:t}=await j.from("organization_users").select("email").eq("user_id",r.invited_by_user_id).eq("organization_id",s).single();return{...r,invited_by:t?{email:t.email}:null}}catch(t){return console.error("Error fetching invited by user:",t),{...r,invited_by:null}}return r}))},enabled:!!s,retry:2,staleTime:30*1e3}),Un=({rpcName:s,queryKeysToInvalidate:n,successMessage:a,errorMessage:i,onSuccessCustom:r,paramsMapper:t})=>{const o=O();return F({mutationFn:async l=>{const{data:v,error:c}=await j.rpc(s,t(l));if(c)throw c;const u=v;if(u&&typeof u=="object"&&"success"in u){const N=u;if(!N.success)throw new Error(N.error)}return u},onSuccess:l=>{n.forEach(v=>{o.invalidateQueries({queryKey:v})}),r?r(l):C.success(a)},onError:l=>{C.error(l.message||i)}})},Tn=()=>{const s=O();return F({mutationFn:async n=>{m.info("useEnhancedCancelInvitation: Cancelling invitation",{invitationId:n});const{data:a,error:i}=await j.from("user_invitations").select("email, organization_id").eq("id",n).single();if(i)throw new Error("Failed to fetch invitation details");const{error:r}=await j.from("user_invitations").delete().eq("id",n);if(r)throw new Error("Failed to cancel invitation");const{error:t}=await j.from("organization_users").delete().eq("email",a.email).eq("organization_id",a.organization_id);t&&m.warn("Could not remove user from organization_users (may not exist)",{email:a.email,organizationId:a.organization_id})},onSuccess:()=>{s.invalidateQueries({queryKey:["organization-invitations"]}),s.invalidateQueries({queryKey:["organization-members"]}),C.success("Invitation cancelled and user removed successfully"),m.info("useEnhancedCancelInvitation: Invitation cancelled successfully")},onError:n=>{m.error("useEnhancedCancelInvitation: Cancellation failed",{error:n.message}),C.error(n.message||"Failed to cancel invitation")}})},Dn={ORGANIZATION_MEMBERS:["organization-members"],ORGANIZATION_INVITATIONS:["organization-invitations"]},Ln=Tn,zn=()=>Un({rpcName:"remove_user_from_organization",queryKeysToInvalidate:[Dn.ORGANIZATION_MEMBERS],successMessage:"User removed from organization successfully",errorMessage:"Failed to remove user",paramsMapper:({userId:s,organizationId:n})=>({p_user_id:s,p_organization_id:n})}),On=s=>{const n=Mn(s),{data:a=[],isLoading:i,error:r}=Cn(s),t=Ln(),o=l=>{t.mutate(l)};return{...n,pendingInvitations:a,invitationsLoading:i,invitationsError:r,pendingInvitationsCount:a.length,handleCancelInvitation:o,cancelInvitationLoading:t.isPending}},Fn=({organizationName:s})=>e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"User Management"}),e.jsxs("p",{className:"text-gray-600",children:["Manage members and invitations for ",s]})]})}),Pn=({activeMembersCount:s,adminsCount:n,pendingInvitationsCount:a})=>e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(w,{children:e.jsx(R,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($e,{className:"h-5 w-5 text-sunset-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:s}),e.jsx("p",{className:"text-sm text-gray-600",children:"Total Members"})]})]})})}),e.jsx(w,{children:e.jsx(R,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(an,{className:"h-5 w-5 text-coral-500"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:n}),e.jsx("p",{className:"text-sm text-gray-600",children:"Admins"})]})]})})}),e.jsx(w,{children:e.jsx(R,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(k,{className:"h-5 w-5 text-golden-500"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:a}),e.jsx("p",{className:"text-sm text-gray-600",children:"Pending Invitations"})]})]})})})]}),Vn=s=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.trim()),qn=s=>s==null?!1:typeof s=="string"?s.trim().length>0:Array.isArray(s)?s.length>0:!0,kn=(s,n=0,a=1/0)=>{const i=s.trim().length;return i>=n&&i<=a},Te=s=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s),S={required:s=>({validate:qn,message:`${s} is required`,code:f.VALIDATION_REQUIRED_FIELD}),email:()=>({validate:Vn,message:"Please provide a valid email address",code:f.VALIDATION_INVALID_EMAIL}),length:(s,n,a)=>({validate:i=>kn(i,s,n),message:`${a} must be between ${s} and ${n} characters`,code:f.VALIDATION_INVALID_FORMAT}),uuid:s=>({validate:Te,message:`${s} must be a valid UUID`,code:f.VALIDATION_INVALID_FORMAT})},De=(s,n)=>{const a=[];for(const i of n)i.validate(s)||a.push(b(i.code,i.message,"medium"));return{isValid:a.length===0,errors:a}},X=(s,n)=>{const a=[];for(const[i,r]of Object.entries(n)){const t=s[i],o=De(t,r);a.push(...o.errors)}return{isValid:a.length===0,errors:a}},Bn=s=>s.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;"),Kn=s=>{const n=Bn(s).toLowerCase(),a=De(n,[S.email()]);return{...a,sanitizedEmail:a.isValid?n:void 0}};class Y{constructor(n){P(this,"_value");this._value=n}static create(n){const a=Kn(n);if(!a.isValid){const i=a.errors[0]||b(f.VALIDATION_INVALID_EMAIL,"Invalid email format","medium");throw new Error(i.message)}return new Y(a.sanitizedEmail)}get value(){return this._value}equals(n){return this._value===n._value}toString(){return this._value}}class W{constructor(n){P(this,"_value");this._value=n}static create(n){if(!Te(n)){const a=b(f.VALIDATION_INVALID_FORMAT,"Invalid organization ID format","medium");throw new Error(a.message)}return new W(n)}get value(){return this._value}equals(n){return this._value===n._value}toString(){return this._value}}class $n{validateInvitationRequest(n){const a={organizationId:n.organizationId,role:n.role,email:n.email,enhancedRole:n.enhancedRole};return X(a,{organizationId:[S.required("Organization ID"),S.uuid("Organization ID")],role:[S.required("Role"),S.length(1,50,"Role")]})}processSupabaseResponse(n,a){var i;if(a){const r=a instanceof Error?a.message:String(a);if(r.includes("NetworkError")||r.includes("Failed to fetch")){const o=b(f.SYSTEM_NETWORK_ERROR,"Network connection failed. Please check your internet connection.","high");return E("Network error in invitation service",{originalError:r}),I(o)}if(r.includes("FunctionsError")){const o=typeof n=="object"&&n!==null&&"error"in n?String(n.error):"Service temporarily unavailable. Please try again.",l=b(f.SYSTEM_DATABASE_ERROR,o,"high");return E("Database error in invitation service",{originalError:r}),I(l)}const t=V(a,"Failed to process invitation");return E("Unknown error in invitation process"),I(t)}if(!n){const r=b(f.SYSTEM_UNKNOWN_ERROR,"No response received from invitation service","high");return E("No data received from invitation service"),I(r)}if(typeof n=="object"&&n!==null&&"success"in n){const r=n;if(r.success===!1){const t=(i=r.message)!=null&&i.includes("already exists")?f.BUSINESS_USER_ALREADY_EXISTS:f.BUSINESS_ORGANIZATION_NOT_FOUND,o=b(t,r.message||"Invitation failed","medium");return E("Business logic error in invitation",{response:r}),I(o)}return q(r)}return q({success:!0,message:"Invitation processed successfully",type:"invitation_sent"})}async inviteUser(n){m.info("UserInvitationService: Processing invitation request",{email:n.email,organizationId:n.organizationId,role:n.role});const a=this.validateInvitationRequest(n);if(!a.isValid){const i=a.errors[0];return E("Validation failed for invitation request",{...n}),I(i)}try{const{data:i,error:r}=await j.functions.invoke("invite-user-to-organization",{body:{email:n.email,organizationId:n.organizationId,role:n.role,enhancedRole:n.enhancedRole||n.role}});return m.debug("UserInvitationService: Received response from invitation function",{hasData:!!i,hasError:!!r}),this.processSupabaseResponse(i,r)}catch(i){const r=V(i,"Failed to send invitation. Please try again.");return E("Exception in invitation service",{...n}),I(r)}}async cancelInvitation(n){m.info("UserInvitationService: Cancelling invitation",{invitationId:n.invitationId});const a={invitationId:n.invitationId},i=X(a,{invitationId:[S.required("Invitation ID"),S.uuid("Invitation ID")]});if(!i.isValid){const r=i.errors[0];return E("Validation failed for cancel invitation",{...n}),I(r)}try{const{error:r}=await j.from("user_invitations").update({status:"cancelled"}).eq("id",n.invitationId);if(r){const t=b(f.SYSTEM_DATABASE_ERROR,"Failed to cancel invitation","medium",{supabaseError:r});return E("Database error cancelling invitation",{...n}),I(t)}return m.info("UserInvitationService: Invitation cancelled successfully",{invitationId:n.invitationId}),q(void 0)}catch(r){const t=V(r,"Failed to cancel invitation");return E("Exception cancelling invitation",{...n}),I(t)}}async resendInvitation(n){m.info("UserInvitationService: Resending invitation",{invitationId:n.invitationId});const a=b(f.SYSTEM_UNKNOWN_ERROR,"Resend invitation feature not yet implemented","low");return I(a)}}class Qn{constructor(n=new $n){this.invitationService=n}async inviteUser(n){m.info("UserInvitationApplicationService: Processing invitation request",{email:n.email,organizationId:n.organizationId,role:n.role});try{const a=Y.create(n.email),i=W.create(n.organizationId),r={email:a.value,organizationId:i.value,role:n.role,enhancedRole:n.enhancedRole},t=await this.invitationService.inviteUser(r);return m.info("UserInvitationApplicationService: Invitation processed successfully",{success:t.success}),t}catch(a){throw m.error("UserInvitationApplicationService: Invitation failed",{error:a instanceof Error?a.message:String(a),request:n}),a}}async cancelInvitation(n){return m.info("UserInvitationApplicationService: Cancelling invitation",{invitationId:n}),this.invitationService.cancelInvitation({invitationId:n})}async resendInvitation(n){return m.info("UserInvitationApplicationService: Resending invitation",{invitationId:n}),this.invitationService.resendInvitation({invitationId:n})}}const Yn=new Qn,Wn=()=>{const s=O();return F({mutationFn:async n=>{var a;m.info("useEnhancedInviteUser: Starting invitation process",{email:n.email,organizationId:n.organizationId,role:n.role,enhancedRole:n.enhancedRole});try{const i=await Yn.inviteUser(n);if(!i.success){const r=i;throw new Error(((a=r.error)==null?void 0:a.message)||"Invitation failed")}return i.data}catch(i){m.error("useEnhancedInviteUser: Invitation failed",{error:i instanceof Error?i.message:String(i),params:n});const r=i instanceof Error?i.message:"Failed to invite user. Please try again.";throw new Error(r)}},onSuccess:n=>{[{queryKey:["organization-members"]},{queryKey:["organization-invitations"]}].forEach(({queryKey:r})=>{s.invalidateQueries({queryKey:r})});const i=n.type==="direct_add"?"User added to organization successfully!":"Invitation sent successfully! The user will receive an email with instructions to join.";C.success(i),m.info("useEnhancedInviteUser: Invitation completed successfully",{type:n.type,message:n.message})},onError:n=>{m.error("useEnhancedInviteUser: Invitation mutation failed",{error:n.message}),C.error(n.message||"Failed to invite user")}})},ee={email:"",role:"member"},Gn=({organizationId:s,trigger:n})=>{const[a,i]=p.useState(!1),[r,t]=p.useState(ee),[o,l]=p.useState(""),{userRole:v}=Ue(s),c=Wn(),u=()=>{t(ee),l("")},N=d=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d.trim()),h=d=>{d.preventDefault(),l("");const x=r.email.trim();if(!x){l("Email address is required");return}if(!N(x)){l("Please enter a valid email address");return}console.log("Submitting invitation:",{email:x,organizationId:s,role:r.role}),c.mutate({email:x,organizationId:s,role:r.role,enhancedRole:r.role},{onSuccess:()=>{u(),i(!1)},onError:A=>{console.error("Invitation failed:",A),l(A.message||"Failed to send invitation")}})},g=(d,x)=>{t(A=>({...A,[d]:x})),o&&l("")},M=r.email.trim().length>0&&N(r.email.trim()),U=e.jsxs(T,{children:[e.jsx(yn,{className:"w-4 h-4 mr-2"}),"Invite User"]});return e.jsxs(on,{open:a,onOpenChange:d=>{i(d),d||u()},children:[e.jsx(ln,{asChild:!0,children:n||U}),e.jsxs(cn,{className:"sm:max-w-md",children:[e.jsx(dn,{children:e.jsx(un,{children:"Invite User to Organization"})}),e.jsxs("form",{onSubmit:h,className:"space-y-4",children:[o&&e.jsxs(ae,{variant:"destructive",children:[e.jsx(Qe,{className:"h-4 w-4"}),e.jsx(ie,{children:o})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"email",children:"Email Address"}),e.jsx(Ye,{id:"email",type:"email",placeholder:"user@example.com",value:r.email,onChange:d=>g("email",d.target.value),required:!0,className:o&&o.includes("email")?"border-red-500":""}),e.jsx("p",{className:"text-sm text-gray-500",children:"The user will receive an email invitation to join your organization and set up their account."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{htmlFor:"role",children:"Role"}),e.jsx(ye,{currentUserRole:v||"member",selectedRole:r.role,onRoleChange:d=>g("role",d)})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(T,{type:"button",variant:"outline",onClick:()=>i(!1),disabled:c.isPending,children:"Cancel"}),e.jsx(T,{type:"submit",disabled:c.isPending||!M,children:c.isPending?"Sending Invitation...":"Send Invitation"})]})]})]})]})},Hn=({expiresAt:s})=>{const n=rn(s);return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:n?"text-red-600":"",children:L(s)}),n&&e.jsxs(B,{variant:"destructive",className:"flex items-center gap-1",children:[e.jsx(jn,{className:"w-3 h-3"}),"Expiring Soon"]})]})},Zn=({invitation:s,onCancel:n})=>e.jsxs(de,{children:[e.jsx(ue,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"sm",className:"text-red-600 hover:text-red-700",children:e.jsx(We,{className:"h-4 w-4"})})}),e.jsxs(me,{children:[e.jsxs(he,{children:[e.jsx(ve,{children:"Cancel Invitation"}),e.jsxs(ge,{children:["Are you sure you want to cancel the invitation for ",s.email,"? They will no longer be able to join using this invitation."]})]}),e.jsxs(xe,{children:[e.jsx(fe,{children:"Keep Invitation"}),e.jsx(pe,{onClick:()=>n(s.id),className:"bg-red-600 hover:bg-red-700",children:"Cancel Invitation"})]})]})]}),Jn=({invitations:s,loading:n,onCancelInvitation:a})=>n?e.jsx(w,{children:e.jsx(R,{className:"p-6",children:e.jsx("div",{className:"text-center",children:"Loading invitations..."})})}):s.length===0?e.jsx(w,{children:e.jsx(R,{className:"p-6",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(k,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("p",{children:"No pending invitations"}),e.jsx("p",{className:"text-sm",children:"All invitations have been processed"})]})})}):e.jsx(w,{children:e.jsx(R,{className:"p-0",children:e.jsxs(oe,{children:[e.jsx(le,{children:e.jsxs(z,{children:[e.jsx(y,{children:"Email"}),e.jsx(y,{children:"Role"}),e.jsx(y,{children:"Invited"}),e.jsx(y,{children:"Expires"}),e.jsx(y,{children:"Invited By"}),e.jsx(y,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(ce,{children:s.map(i=>{var t;const r=i.enhanced_role||i.role;return e.jsxs(z,{children:[e.jsx(_,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(k,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium",children:i.email})]})}),e.jsx(_,{children:e.jsx(je,{role:r})}),e.jsx(_,{children:L(i.created_at)}),e.jsx(_,{children:e.jsx(Hn,{expiresAt:i.expires_at})}),e.jsx(_,{children:((t=i.invited_by)==null?void 0:t.email)||"-"}),e.jsx(_,{children:e.jsx(Zn,{invitation:i,onCancel:a})})]},i.id)})})]})})}),Xn=({organizationId:s,organizationName:n})=>{const{membersLoading:a,handleUpdateRole:i,activeMembers:r,pendingInvitations:t,invitationsLoading:o,pendingInvitationsCount:l,handleCancelInvitation:v}=On(s),c=zn(),{hasPermission:u,userRole:N,isLoading:h}=te(s),g=x=>{if(!u("manage_users")){console.warn("User attempted to remove member without permission");return}c.mutate({userId:x,organizationId:s})},M=(x,A)=>{if(!u("manage_users")){console.warn("User attempted to update role without permission");return}i(x,A)};if(h||a)return e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading user management..."})]})});if(!u("manage_users"))return e.jsxs(ae,{variant:"destructive",children:[e.jsx(Ge,{className:"h-4 w-4"}),e.jsx(ie,{children:"You don't have permission to manage users. Contact your organization administrator for access."})]});const U=r.filter(x=>{const A=x.enhanced_role||x.role;return["admin","owner"].includes(A||"")}).length,d=(t==null?void 0:t.length)||0;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(Fn,{organizationName:n}),e.jsx(Gn,{organizationId:s})]}),e.jsx(Pn,{activeMembersCount:r.length,adminsCount:U,pendingInvitationsCount:d}),e.jsxs(He,{defaultValue:"members",className:"w-full",children:[e.jsxs(Ze,{children:[e.jsxs(H,{value:"members",children:["Active Members (",r.length,")"]}),e.jsxs(H,{value:"invitations",children:["Pending Invitations (",d,")"]})]}),e.jsx(Z,{value:"members",children:e.jsx(wn,{members:r,loading:a,organizationId:s,onUpdateRole:M,onRemoveMember:g})}),e.jsx(Z,{value:"invitations",children:e.jsx(Jn,{invitations:t,loading:o,onCancelInvitation:v})})]})]})},es=({organizationId:s,organizationName:n})=>{const{userRole:a,isLoading:i,hasPermission:r}=te(s);return console.log("EnhancedUserManagement:",{organizationId:s,userRole:a,isLoading:i,hasManageUsersPermission:r("manage_users")}),e.jsx(tn,{permission:"manage_users",organizationId:s,showRequiredRole:!0,fallback:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need manager-level access or higher to manage users."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."}),a&&e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["Current role: ",a]})]}),children:e.jsx(Xn,{organizationId:s,organizationName:n})})},ms=({organization:s})=>e.jsx(es,{organizationId:s.id,organizationName:s.name});export{ms as default};
