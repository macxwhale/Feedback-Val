var F=Object.defineProperty;var K=(t,s,a)=>s in t?F(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a;var D=(t,s,a)=>K(t,typeof s!="symbol"?s+"":s,a);import{c as U,u as S,s as N,j as e,h as O,C as h,a as g,b,e as x,B as A,R as B,T as R,g as P,i as M,M as G,k as Q,l as T,m as C,r as _,n as Y,o as $,U as H,p as W,A as X,q as V,t as z,v as J,w as L,x as Z,d as q,y as I,L as ee,z as se,X as te,Y as ae,D as re,F as ie,G as k,P as ne}from"./index-CD5iky1y.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=U("ChartLine",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"m19 9-5 5-4-4-3 3",key:"2osh9i"}]]),oe=t=>S({queryKey:["organization-stats",t],queryFn:async()=>{const{data:s,error:a}=await N.rpc("get_organization_stats",{org_id:t});if(a)throw a;return s},enabled:!!t,staleTime:3e4,refetchInterval:6e4}),w=({className:t,count:s=1})=>e.jsx(e.Fragment,{children:Array.from({length:s}).map((a,i)=>e.jsx("div",{className:O("animate-pulse rounded-md bg-muted",t)},i))}),ce=()=>e.jsxs("div",{className:"rounded-lg border bg-card p-6 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(w,{className:"h-4 w-24"}),e.jsx(w,{className:"h-8 w-8 rounded-lg"})]}),e.jsx(w,{className:"h-8 w-16"}),e.jsx(w,{className:"h-4 w-20"})]}),de=({cards:t,isLoading:s=!1,className:a="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"})=>s?e.jsx("div",{className:a,children:Array.from({length:6}).map((i,l)=>e.jsx(ce,{},l))}):e.jsx("div",{className:a,children:t.map(i=>{const l=i.icon;return e.jsxs(h,{className:"transition-all hover:shadow-md",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(b,{className:"text-sm font-medium text-gray-600",children:i.title}),e.jsx("div",{className:`p-2 rounded-lg ${i.bgColor}`,children:e.jsx(l,{className:`h-4 w-4 ${i.color}`})})]}),e.jsxs(x,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[i.value,i.suffix||""]}),i.trend&&e.jsxs("div",{className:"mt-2 flex items-center text-sm",children:[e.jsxs(A,{variant:i.trend.isPositive?"default":"secondary",className:"text-xs",children:[i.trend.isPositive?"+":"",i.trend.value,"%"]}),e.jsx("span",{className:"ml-2 text-muted-foreground",children:i.trend.label})]})]})]},i.title)})});class me extends B.Component{constructor(a){super(a);D(this,"handleRetry",()=>{this.setState({hasError:!1,error:void 0})});this.state={hasError:!1}}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,i){console.error("Dashboard Error:",a,i)}render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsxs(h,{className:"border-destructive",children:[e.jsx(g,{children:e.jsxs(b,{className:"flex items-center text-destructive",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),"Dashboard Error"]})}),e.jsxs(x,{className:"space-y-4",children:[e.jsx("p",{className:"text-muted-foreground",children:"Something went wrong while loading the dashboard. Please try again."}),this.state.error&&e.jsxs("details",{className:"text-sm text-muted-foreground",children:[e.jsx("summary",{children:"Error details"}),e.jsx("pre",{className:"mt-2 text-xs",children:this.state.error.message})]}),e.jsxs(P,{onClick:this.handleRetry,variant:"outline",children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Try Again"]})]})]}):this.props.children}}const he=({onRetry:t})=>e.jsx(h,{className:"border-destructive",children:e.jsxs(x,{className:"p-6 text-center",children:[e.jsx(R,{className:"w-12 h-12 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Unable to load dashboard"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"There was an error loading your dashboard data."}),e.jsxs(P,{onClick:t,variant:"outline",children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Retry"]})]})}),E=({organizationId:t})=>{const{data:s,isLoading:a,error:i,refetch:l}=oe(t);if(i)return e.jsx(he,{onRetry:()=>l()});const r=[{title:"Total Questions",value:(s==null?void 0:s.total_questions)||0,icon:G,color:"text-green-600",bgColor:"bg-green-50",trend:{value:8,label:"new this month",isPositive:!0}},{title:"Total Sessions",value:(s==null?void 0:s.total_sessions)||0,icon:Q,color:"text-purple-600",bgColor:"bg-purple-50",trend:{value:23,label:"vs last month",isPositive:!0}},{title:"Completed Sessions",value:(s==null?void 0:s.completed_sessions)||0,icon:T,color:"text-emerald-600",bgColor:"bg-emerald-50",trend:s&&s.total_sessions>0?{value:Math.round(s.completed_sessions/s.total_sessions*100),label:"completion rate",isPositive:!0}:void 0},{title:"Total Responses",value:(s==null?void 0:s.total_responses)||0,icon:C,color:"text-orange-600",bgColor:"bg-orange-50",trend:{value:34,label:"vs last month",isPositive:!0}}];return e.jsx(me,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(de,{cards:r,isLoading:a}),!a&&s&&s.total_sessions>0&&e.jsx("div",{className:"flex justify-center",children:e.jsxs(A,{variant:"outline",className:"text-sm",children:["Overall completion rate: ",Math.round(s.completed_sessions/s.total_sessions*100),"%"]})})]})})},xe=t=>{const[s,a]=_.useState({activeUsers:0,feedbackSubmissions:0,averageScore:0,responseTime:0}),[i,l]=_.useState(!0),r=async()=>{try{const c=new Date(Date.now()-6e5).toISOString(),{data:n}=await N.from("feedback_sessions").select("id").eq("organization_id",t).gte("started_at",c),{data:o}=await N.from("feedback_responses").select("id, score").eq("organization_id",t).gte("created_at",c),{data:m}=await N.from("feedback_sessions").select("started_at, completed_at").eq("organization_id",t).eq("status","completed").not("completed_at","is",null).order("completed_at",{ascending:!1}).limit(50);let j=0;m&&m.length>0&&(j=m.reduce((v,p)=>{const f=new Date(p.started_at).getTime(),y=new Date(p.completed_at).getTime();return v+(y-f)},0)/m.length/(1e3*60));let u=0;if(o&&o.length>0){const d=o.filter(v=>v.score!==null);d.length>0&&(u=d.reduce((v,p)=>v+p.score,0)/d.length)}a({activeUsers:(n==null?void 0:n.length)||0,feedbackSubmissions:(o==null?void 0:o.length)||0,averageScore:Math.round(u*10)/10,responseTime:Math.round(j*10)/10})}catch(c){console.error("Error fetching real-time analytics:",c)}finally{l(!1)}};return _.useEffect(()=>{if(!t)return;r();const c=setInterval(r,3e4);return()=>clearInterval(c)},[t]),{liveData:s,isLoading:i,refetch:r}},ue=({organizationId:t})=>{const{liveData:s,isLoading:a}=xe(t);return a?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 animate-pulse",children:[e.jsx("div",{className:"h-32 bg-gray-200 rounded"}),e.jsx("div",{className:"h-32 bg-gray-200 rounded"})]}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(h,{children:[e.jsx(g,{children:e.jsx(b,{children:"Feedback Submissions (Last 10 min)"})}),e.jsx(x,{children:e.jsx("div",{className:"text-4xl font-bold",children:s.feedbackSubmissions})})]}),e.jsxs(h,{children:[e.jsx(g,{children:e.jsx(b,{children:"Response Time (min)"})}),e.jsx(x,{children:e.jsx("div",{className:"text-4xl font-bold",children:s.responseTime})})]})]})},ge=t=>S({queryKey:["executive-analytics",t],queryFn:async()=>{const s=new Date;s.setDate(1);const a=new Date(s);a.setMonth(a.getMonth()-1);const{data:i}=await N.from("feedback_sessions").select("total_score").eq("organization_id",t).not("total_score","is",null),l=i&&i.length>0?i.reduce((u,d)=>u+d.total_score,0)/i.length/5*5:0,{data:r}=await N.from("feedback_sessions").select("id, status").eq("organization_id",t),c=(r==null?void 0:r.filter(u=>u.status==="completed").length)||0,n=r&&r.length>0?c/r.length*100:0,{data:o}=await N.from("feedback_sessions").select("started_at, completed_at").eq("organization_id",t).eq("status","completed").not("completed_at","is",null);let m=0;o&&o.length>0&&(m=o.reduce((d,v)=>{const p=new Date(v.started_at).getTime(),f=new Date(v.completed_at).getTime();return d+(f-p)},0)/o.length/(1e3*60*60*24));const j=r&&r.length>0?Math.max(.5,2-r.length/100):1;return[{title:"Customer Satisfaction",value:Math.round(l*10)/10,target:4.5,trend:"+5%",isPositive:!0,suffix:"/5"},{title:"Response Rate",value:Math.round(n),target:90,trend:"+12%",isPositive:!0,suffix:"%"},{title:"Issue Resolution Time",value:Math.round(m*10)/10,target:2,trend:"-8%",isPositive:!0,suffix:" days"},{title:"Cost per Feedback",value:Math.round(j*100)/100,target:1,trend:"-15%",isPositive:!0,prefix:"$"}]},enabled:!!t,staleTime:5*60*1e3}),je=({organizationId:t})=>{const{data:s,isLoading:a,error:i}=ge(t);if(i)return e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(R,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Error Loading Executive Dashboard"}),e.jsx("p",{className:"text-gray-600",children:"Unable to load executive analytics data. Please try again."})]});if(a)return e.jsx("div",{className:"space-y-6",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[1,2,3].map(r=>e.jsx("div",{className:"h-32 bg-gray-200 rounded animate-pulse"},r))})});const l=(s==null?void 0:s.filter(r=>r.title!=="Cost per Feedback"))||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:l.map((r,c)=>e.jsxs(h,{className:"border-l-4 border-l-blue-500",children:[e.jsx(g,{className:"pb-2",children:e.jsx(b,{className:"text-sm font-medium text-gray-600",children:r.title})}),e.jsx(x,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[r.prefix,r.value,r.suffix]}),e.jsxs("div",{className:"text-sm text-gray-500",children:["Target: ",r.prefix,r.target,r.suffix]})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsxs(A,{variant:r.isPositive?"default":"secondary",className:"mb-2",children:[r.isPositive?e.jsx(C,{className:"w-3 h-3 mr-1"}):e.jsx(Y,{className:"w-3 h-3 mr-1"}),r.trend]}),r.title==="Customer Satisfaction"&&e.jsx($,{className:"w-5 h-5 text-blue-600"}),r.title==="Response Rate"&&e.jsx(H,{className:"w-5 h-5 text-green-600"}),r.title==="Issue Resolution Time"&&e.jsx(T,{className:"w-5 h-5 text-orange-600"})]})]})})]},c))}),e.jsxs(h,{children:[e.jsx(g,{children:e.jsx(b,{children:"Critical Insights & Alerts"})}),e.jsx(x,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"font-medium text-green-900",children:"Performance Above Target"})]}),e.jsx("p",{className:"text-sm text-green-700 mt-1",children:"Customer satisfaction is consistently above 4.0/5 target"})]}),e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(C,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-900",children:"Positive Trend"})]}),e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:"Response rates have improved by 12% this month"})]})]})})]}),e.jsxs(h,{children:[e.jsx(g,{children:e.jsx(b,{children:"Data-Driven Recommendations"})}),e.jsx(x,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 border-l-4 border-l-blue-500 bg-blue-50",children:[e.jsx("h4",{className:"font-medium",children:"Optimize Response Collection"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Consider implementing automated follow-ups to maintain high response rates"})]}),e.jsxs("div",{className:"p-3 border-l-4 border-l-green-500 bg-green-50",children:[e.jsx("h4",{className:"font-medium",children:"Leverage High Satisfaction Areas"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Replicate successful practices from high-performing categories"})]})]})})]})]})},ve=t=>S({queryKey:["enhanced-organization-stats",t],queryFn:async()=>{const{data:s,error:a}=await N.rpc("get_organization_stats_enhanced",{org_id:t});if(a)throw a;return s},enabled:!!t,staleTime:3e4,refetchInterval:6e4}),pe=({data:t,isLoading:s})=>s?e.jsxs(h,{children:[e.jsxs(g,{children:[e.jsx("div",{className:"h-6 w-1/3 rounded bg-gray-200 animate-pulse mb-2"}),e.jsx("div",{className:"h-4 w-1/2 rounded bg-gray-200 animate-pulse"})]}),e.jsx(x,{children:e.jsx("div",{className:"h-80 rounded bg-gray-200 animate-pulse"})})]}):!t||t.length===0?e.jsxs(h,{children:[e.jsxs(g,{children:[e.jsx(b,{children:"Trend Analysis"}),e.jsx(q,{children:"Key metrics over the selected period."})]}),e.jsx(x,{children:e.jsxs("div",{className:"h-80 flex flex-col items-center justify-center text-center text-gray-500",children:[e.jsx(le,{className:"w-12 h-12 mb-4"}),e.jsx("p",{className:"font-semibold",children:"No Trend Data Available"}),e.jsx("p",{className:"text-sm",children:"Try selecting a different date range to see trend analysis."})]})})]}):e.jsxs(h,{children:[e.jsxs(g,{children:[e.jsx(b,{children:"Trend Analysis"}),e.jsx(q,{children:"Key metrics over the selected period."})]}),e.jsx(x,{children:e.jsx("div",{className:"h-80 -ml-4",children:e.jsx(I,{width:"100%",height:"100%",children:e.jsxs(ee,{data:t,margin:{top:5,right:30,left:0,bottom:5},children:[e.jsx(se,{strokeDasharray:"3 3"}),e.jsx(te,{dataKey:"date"}),e.jsx(ae,{domain:[0,100],unit:"%"}),e.jsx(re,{contentStyle:{backgroundColor:"hsl(var(--background))",border:"1px solid hsl(var(--border))",borderRadius:"var(--radius)"}}),e.jsx(ie,{}),e.jsx(k,{type:"monotone",dataKey:"completion_rate",name:"Completion Rate",stroke:"hsl(var(--primary))",strokeWidth:2,dot:{r:4},activeDot:{r:8}}),e.jsx(k,{type:"monotone",dataKey:"avg_score",name:"Average Score",stroke:"hsl(var(--destructive))",strokeWidth:2,dot:{r:4},activeDot:{r:8}})]})})})})]}),fe=({organizationId:t,organizationName:s,activeTab:a,stats:i,isLiveActivity:l,setIsLiveActivity:r,handleQuickActions:c})=>{const{data:n,isLoading:o,error:m}=W(t),{data:j,isLoading:u,error:d}=ve(t);if(o&&u)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[1,2,3,4].map(y=>e.jsx("div",{className:"h-32 bg-gray-200 rounded animate-pulse"},y))}),e.jsx("div",{className:"h-64 bg-gray-200 rounded animate-pulse"})]});const p={...(n==null?void 0:n.summary)||{total_questions:0,total_responses:0,overall_completion_rate:0},overall_avg_score:(j==null?void 0:j.avg_session_score)||0},f=m||d?e.jsxs(X,{variant:"destructive",className:"mb-4",children:[e.jsx(V,{className:"h-4 w-4"}),e.jsx(z,{children:"Error"}),e.jsxs(J,{children:["Some dashboard data may be unavailable. ",(m==null?void 0:m.message)||(d==null?void 0:d.message)]})]}):null;return a==="overview"?e.jsxs("div",{className:"space-y-6",children:[f,e.jsx(E,{organizationId:t}),e.jsx(pe,{data:(n==null?void 0:n.trendData)||[],isLoading:o}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(L,{questions:(n==null?void 0:n.questions)||[],categories:(n==null?void 0:n.categories)||[],summary:p}),e.jsx(Z,{stats:j,isLoading:u})]})]}):a==="executive"?e.jsxs("div",{className:"space-y-6",children:[f,e.jsx(je,{organizationId:t})]}):a==="realtime"?e.jsxs("div",{className:"space-y-6",children:[f,e.jsx(ue,{organizationId:t})]}):a==="detailed"?e.jsxs("div",{className:"space-y-6",children:[f,e.jsx(L,{questions:(n==null?void 0:n.questions)||[],categories:(n==null?void 0:n.categories)||[],summary:p,showDrillDown:!0})]}):e.jsxs(e.Fragment,{children:[f,e.jsx(E,{organizationId:t})]})},ye=({organization:t,stats:s,activeTab:a,setActiveTab:i,isLiveActivity:l,setIsLiveActivity:r,handleQuickActions:c})=>e.jsx(ne,{permission:"view_analytics",organizationId:t.id,showRequiredRole:!0,fallback:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need viewer-level access or higher to view analytics."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]}),children:e.jsx(fe,{organizationId:t.id,organizationName:t.name,activeTab:a,onTabChange:i,stats:s,isLiveActivity:l,setIsLiveActivity:r,handleQuickActions:c})});export{ye as AdvancedDashboardTab,ye as default};
