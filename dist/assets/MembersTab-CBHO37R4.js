var De=Object.defineProperty;var Le=(s,n,a)=>n in s?De(s,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[n]=a;var P=(s,n,a)=>Le(s,typeof n!="symbol"?n+"":n,a);import{c as ze,F as ne,j as e,i as B,G as Oe,H as Fe,r as p,P as K,J as Pe,K as se,a as $,L as qe,N as Ve,u as D,s as j,O as ke,C as R,l as w,Q as Be,V as Ke,W as L,D as $e,d as Qe,B as T,e as Ye,h as We,X as Ge,Y as O,_ as C,$ as m,U as He,a0 as Ze,a1 as k,a2 as f,a3 as b,a4 as E,a5 as I,a6 as q,a7 as V,a8 as ae,a9 as ie,I as Je,aa as Xe,ab as en,ac as nn,ad as re,T as sn}from"./index-DSyFPu6e.js";import{P as an}from"./PermissionGuard-7Hg8hmcJ.js";import{T as te,a as oe,b as z,c as y,d as le,e as _,A as ce,f as de,g as ue,h as me,i as he,j as ve,k as ge,l as xe,m as fe,D as rn,n as tn,o as on,p as ln,q as cn}from"./dialog-B8-11T18.js";import{S as dn,a as un,b as mn,c as hn,d as vn}from"./select-HbqDsqMm.js";import{E as gn}from"./ellipsis-Cx3k-m1Y.js";import{T as xn}from"./trash-2-IrkBwtsK.js";import{u as F,t as G,L as H}from"./label-aXPw7gIn.js";import{C as fn}from"./circle-alert-KjjM8qDc.js";import{T as pn,a as jn,b as Z,c as J}from"./tabs-DcCN0eho.js";import"./index-851r-13A.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yn=ze("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),pe=({role:s,showIcon:n=!1,className:a=""})=>{const r=ne(s),i=r.icon;return e.jsxs(B,{variant:r.variant,className:a,children:[n&&e.jsx(i,{className:"w-3 h-3 mr-1"}),r.label]})},je=({currentUserRole:s,selectedRole:n,onRoleChange:a,disabled:r=!1})=>{const i=Oe(s),t=[...i];return n&&!i.includes(n)&&t.push(n),e.jsxs(dn,{value:n,onValueChange:a,disabled:r,children:[e.jsx(un,{children:e.jsx(mn,{placeholder:"Select a role"})}),e.jsx(hn,{children:t.map(o=>{const l=ne(o);return e.jsx(vn,{value:o,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l.icon,{className:"w-4 h-4"}),e.jsx("span",{children:l.label})]})},o)})})]})};var Q="Avatar",[_n,ms]=Fe(Q),[In,ye]=_n(Q),_e=p.forwardRef((s,n)=>{const{__scopeAvatar:a,...r}=s,[i,t]=p.useState("idle");return e.jsx(In,{scope:a,imageLoadingStatus:i,onImageLoadingStatusChange:t,children:e.jsx(K.span,{...r,ref:n})})});_e.displayName=Q;var Ie="AvatarImage",Ne=p.forwardRef((s,n)=>{const{__scopeAvatar:a,src:r,onLoadingStatusChange:i=()=>{},...t}=s,o=ye(Ie,a),l=Nn(r,t.referrerPolicy),v=Pe(c=>{i(c),o.onImageLoadingStatusChange(c)});return se(()=>{l!=="idle"&&v(l)},[l,v]),l==="loaded"?e.jsx(K.img,{...t,ref:n,src:r}):null});Ne.displayName=Ie;var Ee="AvatarFallback",be=p.forwardRef((s,n)=>{const{__scopeAvatar:a,delayMs:r,...i}=s,t=ye(Ee,a),[o,l]=p.useState(r===void 0);return p.useEffect(()=>{if(r!==void 0){const v=window.setTimeout(()=>l(!0),r);return()=>window.clearTimeout(v)}},[r]),o&&t.imageLoadingStatus!=="loaded"?e.jsx(K.span,{...i,ref:n}):null});be.displayName=Ee;function Nn(s,n){const[a,r]=p.useState("idle");return se(()=>{if(!s){r("error");return}let i=!0;const t=new window.Image,o=l=>()=>{i&&r(l)};return r("loading"),t.onload=o("loaded"),t.onerror=o("error"),t.src=s,n&&(t.referrerPolicy=n),()=>{i=!1}},[s,n]),a}var Re=_e,we=Ne,Ae=be;const Se=p.forwardRef(({className:s,...n},a)=>e.jsx(Re,{ref:a,className:$("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...n}));Se.displayName=Re.displayName;const En=p.forwardRef(({className:s,...n},a)=>e.jsx(we,{ref:a,className:$("aspect-square h-full w-full",s),...n}));En.displayName=we.displayName;const Me=p.forwardRef(({className:s,...n},a)=>e.jsx(Ae,{ref:a,className:$("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...n}));Me.displayName=Ae.displayName;const bn=({email:s,size:n="md"})=>{const a={sm:"h-6 w-6",md:"h-8 w-8",lg:"h-10 w-10"};return e.jsx(Se,{className:a[n],children:e.jsx(Me,{children:qe(s)})})},Ce=s=>{const{user:n}=Ve(),{data:a}=D({queryKey:["user-enhanced-role",n==null?void 0:n.id,s],queryFn:async()=>{if(!(n!=null&&n.id)||!s)return null;const{data:h}=await j.from("organization_users").select("enhanced_role").eq("user_id",n.id).eq("organization_id",s).single();return(h==null?void 0:h.enhanced_role)||null},enabled:!!(n!=null&&n.id)&&!!s}),{data:r}=D({queryKey:["user-permissions",n==null?void 0:n.id,s,a],queryFn:async()=>{if(!(n!=null&&n.id)||!s||!a)return{};const{data:h}=await j.from("role_permissions").select("permission_key, permission_value").eq("role",a),g={};return h==null||h.forEach(({permission_key:M,permission_value:U})=>{try{const d=U;d&&typeof d=="object"&&"allowed"in d&&(g[M]=d)}catch(d){console.warn(`Failed to parse permission for ${M}:`,d)}}),g},enabled:!!(n!=null&&n.id)&&!!s&&!!a}),i=h=>{if(!a)return!1;const g=r==null?void 0:r[h];return g?g.allowed:ke(a,h)};return{userRole:a,permissions:r,checkPermission:i,canManageUsers:()=>i("manage_users"),canManageOrganization:()=>i("manage_organization"),canViewAnalytics:()=>i("view_analytics"),canExportData:()=>i("export_data"),canManageQuestions:()=>i("manage_questions"),canManageIntegrations:()=>i("manage_integrations"),canManageBilling:()=>i("manage_billing")}},Rn=({members:s,loading:n,organizationId:a,onUpdateRole:r,onRemoveMember:i})=>{const{userRole:t,canManageUsers:o}=Ce(a),l=(c,u)=>{r(c.user_id,u)},v=c=>{if(!o()||!t)return!1;const u=c.enhanced_role||c.role||"member";return Ge(t,u)};return n?e.jsx(R,{children:e.jsx(w,{className:"p-6",children:e.jsx("div",{className:"text-center",children:"Loading members..."})})}):!s||s.length===0?e.jsx(R,{children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(Be,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("p",{children:"No members found"}),e.jsx("p",{className:"text-sm",children:"Invite users to get started"})]})})}):e.jsx(R,{children:e.jsx(w,{className:"p-0",children:e.jsxs(te,{children:[e.jsx(oe,{children:e.jsxs(z,{children:[e.jsx(y,{children:"Member"}),e.jsx(y,{children:"Role"}),e.jsx(y,{children:"Status"}),e.jsx(y,{children:"Joined"}),e.jsx(y,{children:"Invited By"}),e.jsx(y,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(le,{children:s.map(c=>{var h;const u=c.enhanced_role||c.role||"member",N=v(c);return e.jsxs(z,{children:[e.jsx(_,{children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(bn,{email:c.email}),e.jsx("div",{children:e.jsx("div",{className:"font-medium",children:c.email})})]})}),e.jsx(_,{children:N?e.jsx(je,{currentUserRole:t||"member",selectedRole:u,onRoleChange:g=>l(c,g)}):e.jsx(pe,{role:u})}),e.jsx(_,{children:e.jsx(B,{variant:Ke(c.status),children:c.status})}),e.jsx(_,{children:c.accepted_at?L(c.accepted_at):L(c.created_at)}),e.jsx(_,{children:((h=c.invited_by)==null?void 0:h.email)||"-"}),e.jsx(_,{children:N&&e.jsxs($e,{children:[e.jsx(Qe,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"sm",children:e.jsx(gn,{className:"h-4 w-4"})})}),e.jsx(Ye,{align:"end",children:e.jsxs(ce,{children:[e.jsx(de,{asChild:!0,children:e.jsxs(We,{className:"text-red-600",onSelect:g=>g.preventDefault(),children:[e.jsx(xn,{className:"h-4 w-4 mr-2"}),"Remove Member"]})}),e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(he,{children:"Remove Member"}),e.jsxs(ve,{children:["Are you sure you want to remove ",c.email," from this organization? This action cannot be undone."]})]}),e.jsxs(ge,{children:[e.jsx(xe,{children:"Cancel"}),e.jsx(fe,{onClick:()=>i(c.user_id),className:"bg-red-600 hover:bg-red-700",children:"Remove"})]})]})]})})]})})]},c.id)})})]})})})},wn=s=>D({queryKey:["organization-members",s],queryFn:async()=>{console.log("Fetching organization members for:",s);const{data:n,error:a}=await j.from("organization_users").select(`
          id,
          user_id,
          email,
          role,
          enhanced_role,
          status,
          created_at,
          accepted_at,
          invited_by_user_id
        `).eq("organization_id",s).order("created_at",{ascending:!1});if(a)throw console.error("Error fetching organization members:",a),a;const r=await Promise.all((n||[]).map(async i=>{let t=null;if(i.invited_by_user_id){const{data:o}=await j.from("organization_users").select("email").eq("user_id",i.invited_by_user_id).eq("organization_id",s).single();o?t={email:o.email}:t={email:"Unknown"}}return{...i,invited_by:t}}));return console.log("Organization members fetched:",r),r},enabled:!!s,retry:3,retryDelay:1e3}),An=s=>{const{data:n,...a}=wn(s);return{activeMembers:(n==null?void 0:n.filter(i=>i.status==="active"))||[],...a}},Sn=s=>{const n=O();return F({mutationFn:async({userId:a,newRole:r})=>{console.log("Updating user role:",{userId:a,newRole:r,organizationId:s});const{data:i,error:t}=await j.from("organization_users").update({enhanced_role:r,role:r==="owner"||r==="admin"?"admin":"member"}).eq("user_id",a).eq("organization_id",s).select().single();if(t)throw console.error("Error updating user role:",t),t;return i},onSuccess:()=>{G({title:"User role updated successfully"}),n.invalidateQueries({queryKey:["organization-members",s]})},onError:a=>{console.error("Role update error:",a),G({title:"Error updating user role",description:a.message||"An unexpected error occurred",variant:"destructive"})}})},Mn=s=>{const{activeMembers:n,isLoading:a,error:r}=An(s),i=Sn(s);return{activeMembers:n,membersLoading:a,membersError:r,handleUpdateRole:(o,l)=>{i.mutate({userId:o,newRole:l})},updateRoleMutation:i}},Cn=s=>D({queryKey:["organization-invitations",s],queryFn:async()=>{console.log("Fetching organization invitations for:",s);const{data:n,error:a}=await j.from("user_invitations").select(`
          id,
          email,
          role,
          enhanced_role,
          status,
          created_at,
          expires_at,
          invited_by_user_id,
          organization_id
        `).eq("organization_id",s).order("created_at",{ascending:!1});if(a)throw console.error("Error fetching organization invitations:",a),a;return await Promise.all((n||[]).map(async i=>{if(i.invited_by_user_id)try{const{data:t}=await j.from("organization_users").select("email").eq("user_id",i.invited_by_user_id).eq("organization_id",s).single();return{...i,invited_by:t?{email:t.email}:null}}catch(t){return console.error("Error fetching invited by user:",t),{...i,invited_by:null}}return i}))},enabled:!!s,retry:2,staleTime:30*1e3}),Un=({rpcName:s,queryKeysToInvalidate:n,successMessage:a,errorMessage:r,onSuccessCustom:i,paramsMapper:t})=>{const o=O();return F({mutationFn:async l=>{const{data:v,error:c}=await j.rpc(s,t(l));if(c)throw c;const u=v;if(u&&typeof u=="object"&&"success"in u){const N=u;if(!N.success)throw new Error(N.error)}return u},onSuccess:l=>{n.forEach(v=>{o.invalidateQueries({queryKey:v})}),i?i(l):C.success(a)},onError:l=>{C.error(l.message||r)}})},Tn=()=>{const s=O();return F({mutationFn:async n=>{m.info("useEnhancedCancelInvitation: Cancelling invitation",{invitationId:n});const{data:a,error:r}=await j.from("user_invitations").select("email, organization_id").eq("id",n).single();if(r)throw new Error("Failed to fetch invitation details");const{error:i}=await j.from("user_invitations").delete().eq("id",n);if(i)throw new Error("Failed to cancel invitation");const{error:t}=await j.from("organization_users").delete().eq("email",a.email).eq("organization_id",a.organization_id);t&&m.warn("Could not remove user from organization_users (may not exist)",{email:a.email,organizationId:a.organization_id})},onSuccess:()=>{s.invalidateQueries({queryKey:["organization-invitations"]}),s.invalidateQueries({queryKey:["organization-members"]}),C.success("Invitation cancelled and user removed successfully"),m.info("useEnhancedCancelInvitation: Invitation cancelled successfully")},onError:n=>{m.error("useEnhancedCancelInvitation: Cancellation failed",{error:n.message}),C.error(n.message||"Failed to cancel invitation")}})},Dn={ORGANIZATION_MEMBERS:["organization-members"],ORGANIZATION_INVITATIONS:["organization-invitations"]},Ln=Tn,zn=()=>Un({rpcName:"remove_user_from_organization",queryKeysToInvalidate:[Dn.ORGANIZATION_MEMBERS],successMessage:"User removed from organization successfully",errorMessage:"Failed to remove user",paramsMapper:({userId:s,organizationId:n})=>({p_user_id:s,p_organization_id:n})}),On=s=>{const n=Mn(s),{data:a=[],isLoading:r,error:i}=Cn(s),t=Ln(),o=l=>{t.mutate(l)};return{...n,pendingInvitations:a,invitationsLoading:r,invitationsError:i,pendingInvitationsCount:a.length,handleCancelInvitation:o,cancelInvitationLoading:t.isPending}},Fn=({organizationName:s})=>e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"User Management"}),e.jsxs("p",{className:"text-gray-600",children:["Manage members and invitations for ",s]})]})}),Pn=({activeMembersCount:s,adminsCount:n,pendingInvitationsCount:a})=>e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(R,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(He,{className:"h-5 w-5 text-sunset-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:s}),e.jsx("p",{className:"text-sm text-gray-600",children:"Total Members"})]})]})})}),e.jsx(R,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ze,{className:"h-5 w-5 text-coral-500"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:n}),e.jsx("p",{className:"text-sm text-gray-600",children:"Admins"})]})]})})}),e.jsx(R,{children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(k,{className:"h-5 w-5 text-golden-500"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:a}),e.jsx("p",{className:"text-sm text-gray-600",children:"Pending Invitations"})]})]})})})]}),qn=s=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.trim()),Vn=s=>s==null?!1:typeof s=="string"?s.trim().length>0:Array.isArray(s)?s.length>0:!0,kn=(s,n=0,a=1/0)=>{const r=s.trim().length;return r>=n&&r<=a},Ue=s=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s),S={required:s=>({validate:Vn,message:`${s} is required`,code:f.VALIDATION_REQUIRED_FIELD}),email:()=>({validate:qn,message:"Please provide a valid email address",code:f.VALIDATION_INVALID_EMAIL}),length:(s,n,a)=>({validate:r=>kn(r,s,n),message:`${a} must be between ${s} and ${n} characters`,code:f.VALIDATION_INVALID_FORMAT}),uuid:s=>({validate:Ue,message:`${s} must be a valid UUID`,code:f.VALIDATION_INVALID_FORMAT})},Te=(s,n)=>{const a=[];for(const r of n)r.validate(s)||a.push(b(r.code,r.message,"medium"));return{isValid:a.length===0,errors:a}},X=(s,n)=>{const a=[];for(const[r,i]of Object.entries(n)){const t=s[r],o=Te(t,i);a.push(...o.errors)}return{isValid:a.length===0,errors:a}},Bn=s=>s.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;"),Kn=s=>{const n=Bn(s).toLowerCase(),a=Te(n,[S.email()]);return{...a,sanitizedEmail:a.isValid?n:void 0}};class Y{constructor(n){P(this,"_value");this._value=n}static create(n){const a=Kn(n);if(!a.isValid){const r=a.errors[0]||b(f.VALIDATION_INVALID_EMAIL,"Invalid email format","medium");throw new Error(r.message)}return new Y(a.sanitizedEmail)}get value(){return this._value}equals(n){return this._value===n._value}toString(){return this._value}}class W{constructor(n){P(this,"_value");this._value=n}static create(n){if(!Ue(n)){const a=b(f.VALIDATION_INVALID_FORMAT,"Invalid organization ID format","medium");throw new Error(a.message)}return new W(n)}get value(){return this._value}equals(n){return this._value===n._value}toString(){return this._value}}class $n{validateInvitationRequest(n){const a={organizationId:n.organizationId,role:n.role,email:n.email,enhancedRole:n.enhancedRole};return X(a,{organizationId:[S.required("Organization ID"),S.uuid("Organization ID")],role:[S.required("Role"),S.length(1,50,"Role")]})}processSupabaseResponse(n,a){var r;if(a){const i=a instanceof Error?a.message:String(a);if(i.includes("NetworkError")||i.includes("Failed to fetch")){const o=b(f.SYSTEM_NETWORK_ERROR,"Network connection failed. Please check your internet connection.","high");return E("Network error in invitation service",{originalError:i}),I(o)}if(i.includes("FunctionsError")){const o=typeof n=="object"&&n!==null&&"error"in n?String(n.error):"Service temporarily unavailable. Please try again.",l=b(f.SYSTEM_DATABASE_ERROR,o,"high");return E("Database error in invitation service",{originalError:i}),I(l)}const t=q(a,"Failed to process invitation");return E("Unknown error in invitation process"),I(t)}if(!n){const i=b(f.SYSTEM_UNKNOWN_ERROR,"No response received from invitation service","high");return E("No data received from invitation service"),I(i)}if(typeof n=="object"&&n!==null&&"success"in n){const i=n;if(i.success===!1){const t=(r=i.message)!=null&&r.includes("already exists")?f.BUSINESS_USER_ALREADY_EXISTS:f.BUSINESS_ORGANIZATION_NOT_FOUND,o=b(t,i.message||"Invitation failed","medium");return E("Business logic error in invitation",{response:i}),I(o)}return V(i)}return V({success:!0,message:"Invitation processed successfully",type:"invitation_sent"})}async inviteUser(n){m.info("UserInvitationService: Processing invitation request",{email:n.email,organizationId:n.organizationId,role:n.role});const a=this.validateInvitationRequest(n);if(!a.isValid){const r=a.errors[0];return E("Validation failed for invitation request",{...n}),I(r)}try{const r={email:n.email,organizationId:n.organizationId,role:n.role,enhancedRole:n.enhancedRole||n.role},{data:i,error:t}=await j.functions.invoke("enhanced-invite-user",{body:r});return m.debug("UserInvitationService: Received response from edge function",{hasData:!!i,hasError:!!t}),this.processSupabaseResponse(i,t)}catch(r){const i=q(r,"Failed to send invitation. Please try again.");return E("Exception in invitation service",{...n}),I(i)}}async cancelInvitation(n){m.info("UserInvitationService: Cancelling invitation",{invitationId:n.invitationId});const a={invitationId:n.invitationId},r=X(a,{invitationId:[S.required("Invitation ID"),S.uuid("Invitation ID")]});if(!r.isValid){const i=r.errors[0];return E("Validation failed for cancel invitation",{...n}),I(i)}try{const{error:i}=await j.from("user_invitations").update({status:"cancelled"}).eq("id",n.invitationId);if(i){const t=b(f.SYSTEM_DATABASE_ERROR,"Failed to cancel invitation","medium",{supabaseError:i});return E("Database error cancelling invitation",{...n}),I(t)}return m.info("UserInvitationService: Invitation cancelled successfully",{invitationId:n.invitationId}),V(void 0)}catch(i){const t=q(i,"Failed to cancel invitation");return E("Exception cancelling invitation",{...n}),I(t)}}async resendInvitation(n){m.info("UserInvitationService: Resending invitation",{invitationId:n.invitationId});const a=b(f.SYSTEM_UNKNOWN_ERROR,"Resend invitation feature not yet implemented","low");return I(a)}}class Qn{constructor(n=new $n){this.invitationService=n}async inviteUser(n){m.info("UserInvitationApplicationService: Processing invitation request",{email:n.email,organizationId:n.organizationId,role:n.role});try{const a=Y.create(n.email),r=W.create(n.organizationId),i={email:a.value,organizationId:r.value,role:n.role,enhancedRole:n.enhancedRole},t=await this.invitationService.inviteUser(i);return m.info("UserInvitationApplicationService: Invitation processed successfully",{success:t.success}),t}catch(a){throw m.error("UserInvitationApplicationService: Invitation failed",{error:a instanceof Error?a.message:String(a),request:n}),a}}async cancelInvitation(n){return m.info("UserInvitationApplicationService: Cancelling invitation",{invitationId:n}),this.invitationService.cancelInvitation({invitationId:n})}async resendInvitation(n){return m.info("UserInvitationApplicationService: Resending invitation",{invitationId:n}),this.invitationService.resendInvitation({invitationId:n})}}const Yn=new Qn,Wn=()=>{const s=O();return F({mutationFn:async n=>{var a;m.info("useEnhancedInviteUser: Starting invitation process",{email:n.email,organizationId:n.organizationId,role:n.role,enhancedRole:n.enhancedRole});try{const r=await Yn.inviteUser(n);if(!r.success){const i=r;throw new Error(((a=i.error)==null?void 0:a.message)||"Invitation failed")}return r.data}catch(r){m.error("useEnhancedInviteUser: Invitation failed",{error:r instanceof Error?r.message:String(r),params:n});const i=r instanceof Error?r.message:"Failed to invite user. Please try again.";throw new Error(i)}},onSuccess:n=>{[{queryKey:["organization-members"]},{queryKey:["organization-invitations"]}].forEach(({queryKey:i})=>{s.invalidateQueries({queryKey:i})});const r=n.type==="direct_add"?"User added to organization successfully!":"Invitation sent successfully! The user will receive an email with instructions to join.";C.success(r),m.info("useEnhancedInviteUser: Invitation completed successfully",{type:n.type,message:n.message})},onError:n=>{m.error("useEnhancedInviteUser: Invitation mutation failed",{error:n.message}),C.error(n.message||"Failed to invite user")}})},ee={email:"",role:"member"},Gn=({organizationId:s,trigger:n})=>{const[a,r]=p.useState(!1),[i,t]=p.useState(ee),[o,l]=p.useState(""),{userRole:v}=Ce(s),c=Wn(),u=()=>{t(ee),l("")},N=d=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d.trim()),h=d=>{d.preventDefault(),l("");const x=i.email.trim();if(!x){l("Email address is required");return}if(!N(x)){l("Please enter a valid email address");return}console.log("Submitting invitation:",{email:x,organizationId:s,role:i.role}),c.mutate({email:x,organizationId:s,role:i.role,enhancedRole:i.role},{onSuccess:()=>{u(),r(!1)},onError:A=>{console.error("Invitation failed:",A),l(A.message||"Failed to send invitation")}})},g=(d,x)=>{t(A=>({...A,[d]:x})),o&&l("")},M=i.email.trim().length>0&&N(i.email.trim()),U=e.jsxs(T,{children:[e.jsx(yn,{className:"w-4 h-4 mr-2"}),"Invite User"]});return e.jsxs(rn,{open:a,onOpenChange:d=>{r(d),d||u()},children:[e.jsx(tn,{asChild:!0,children:n||U}),e.jsxs(on,{className:"sm:max-w-md",children:[e.jsx(ln,{children:e.jsx(cn,{children:"Invite User to Organization"})}),e.jsxs("form",{onSubmit:h,className:"space-y-4",children:[o&&e.jsxs(ae,{variant:"destructive",children:[e.jsx(fn,{className:"h-4 w-4"}),e.jsx(ie,{children:o})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"email",children:"Email Address"}),e.jsx(Je,{id:"email",type:"email",placeholder:"user@example.com",value:i.email,onChange:d=>g("email",d.target.value),required:!0,className:o&&o.includes("email")?"border-red-500":""}),e.jsx("p",{className:"text-sm text-gray-500",children:"The user will receive an email invitation to join your organization and set up their account."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{htmlFor:"role",children:"Role"}),e.jsx(je,{currentUserRole:v||"member",selectedRole:i.role,onRoleChange:d=>g("role",d)})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx(T,{type:"button",variant:"outline",onClick:()=>r(!1),disabled:c.isPending,children:"Cancel"}),e.jsx(T,{type:"submit",disabled:c.isPending||!M,children:c.isPending?"Sending Invitation...":"Send Invitation"})]})]})]})]})},Hn=({expiresAt:s})=>{const n=Xe(s);return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:n?"text-red-600":"",children:L(s)}),n&&e.jsxs(B,{variant:"destructive",className:"flex items-center gap-1",children:[e.jsx(en,{className:"w-3 h-3"}),"Expiring Soon"]})]})},Zn=({invitation:s,onCancel:n})=>e.jsxs(ce,{children:[e.jsx(de,{asChild:!0,children:e.jsx(T,{variant:"ghost",size:"sm",className:"text-red-600 hover:text-red-700",children:e.jsx(nn,{className:"h-4 w-4"})})}),e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(he,{children:"Cancel Invitation"}),e.jsxs(ve,{children:["Are you sure you want to cancel the invitation for ",s.email,"? They will no longer be able to join using this invitation."]})]}),e.jsxs(ge,{children:[e.jsx(xe,{children:"Keep Invitation"}),e.jsx(fe,{onClick:()=>n(s.id),className:"bg-red-600 hover:bg-red-700",children:"Cancel Invitation"})]})]})]}),Jn=({invitations:s,loading:n,onCancelInvitation:a})=>n?e.jsx(R,{children:e.jsx(w,{className:"p-6",children:e.jsx("div",{className:"text-center",children:"Loading invitations..."})})}):s.length===0?e.jsx(R,{children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(k,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("p",{children:"No pending invitations"}),e.jsx("p",{className:"text-sm",children:"All invitations have been processed"})]})})}):e.jsx(R,{children:e.jsx(w,{className:"p-0",children:e.jsxs(te,{children:[e.jsx(oe,{children:e.jsxs(z,{children:[e.jsx(y,{children:"Email"}),e.jsx(y,{children:"Role"}),e.jsx(y,{children:"Invited"}),e.jsx(y,{children:"Expires"}),e.jsx(y,{children:"Invited By"}),e.jsx(y,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(le,{children:s.map(r=>{var t;const i=r.enhanced_role||r.role;return e.jsxs(z,{children:[e.jsx(_,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(k,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-medium",children:r.email})]})}),e.jsx(_,{children:e.jsx(pe,{role:i})}),e.jsx(_,{children:L(r.created_at)}),e.jsx(_,{children:e.jsx(Hn,{expiresAt:r.expires_at})}),e.jsx(_,{children:((t=r.invited_by)==null?void 0:t.email)||"-"}),e.jsx(_,{children:e.jsx(Zn,{invitation:r,onCancel:a})})]},r.id)})})]})})}),Xn=({organizationId:s,organizationName:n})=>{const{membersLoading:a,handleUpdateRole:r,activeMembers:i,pendingInvitations:t,invitationsLoading:o,pendingInvitationsCount:l,handleCancelInvitation:v}=On(s),c=zn(),{hasPermission:u,userRole:N,isLoading:h}=re(s),g=x=>{if(!u("manage_users")){console.warn("User attempted to remove member without permission");return}c.mutate({userId:x,organizationId:s})},M=(x,A)=>{if(!u("manage_users")){console.warn("User attempted to update role without permission");return}r(x,A)};if(h||a)return e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading user management..."})]})});if(!u("manage_users"))return e.jsxs(ae,{variant:"destructive",children:[e.jsx(sn,{className:"h-4 w-4"}),e.jsx(ie,{children:"You don't have permission to manage users. Contact your organization administrator for access."})]});const U=i.filter(x=>{const A=x.enhanced_role||x.role;return["admin","owner"].includes(A||"")}).length,d=(t==null?void 0:t.length)||0;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(Fn,{organizationName:n}),e.jsx(Gn,{organizationId:s})]}),e.jsx(Pn,{activeMembersCount:i.length,adminsCount:U,pendingInvitationsCount:d}),e.jsxs(pn,{defaultValue:"members",className:"w-full",children:[e.jsxs(jn,{children:[e.jsxs(Z,{value:"members",children:["Active Members (",i.length,")"]}),e.jsxs(Z,{value:"invitations",children:["Pending Invitations (",d,")"]})]}),e.jsx(J,{value:"members",children:e.jsx(Rn,{members:i,loading:a,organizationId:s,onUpdateRole:M,onRemoveMember:g})}),e.jsx(J,{value:"invitations",children:e.jsx(Jn,{invitations:t,loading:o,onCancelInvitation:v})})]})]})},es=({organizationId:s,organizationName:n})=>{const{userRole:a,isLoading:r,hasPermission:i}=re(s);return console.log("EnhancedUserManagement:",{organizationId:s,userRole:a,isLoading:r,hasManageUsersPermission:i("manage_users")}),e.jsx(an,{permission:"manage_users",organizationId:s,showRequiredRole:!0,fallback:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need manager-level access or higher to manage users."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."}),a&&e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["Current role: ",a]})]}),children:e.jsx(Xn,{organizationId:s,organizationName:n})})},hs=({organization:s})=>e.jsx(es,{organizationId:s.id,organizationName:s.name});export{hs as default};
